<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.3, maximum-scale=5.0, user-scalable=yes">
    <title>Rizvi Family Tree ¬∑ Complete Viewer</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
     <style>
        /* ========== CSS STYLES ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --maroon: #5a0000;
            --dark-blue: #0f172a;
            --gold: #d4af37;
            --light-gold: #f1d279;
            --green: #2e7d32;
            --dark-green: #1b5e20;
            --light-green: #d4edda;
            --pink-bg: #fff0f5;
            --light-sage: #f4f7f2;
            --border-sage: #c9d6c2;
            --sisters-border: #fb7185;
            --summary-border: #e6c87c;
            --table-header-bg: #fdf6e3;
            --bronze: #bc8c4f;
            --reset-red: #5a0000;
            --reset-red-dark: #7a1f1f;
            --pdf-grey: #6c757d;
            --pdf-grey-dark: #5a6268;
            --dashboard-green: #1b5e20;
            --sisters-box-bg: #fff0f5;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #1a1a1a;
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 10px;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
            border-radius: 20px;
            border: 2px solid var(--gold);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
        }

        .app-header {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #1e3d3d 100%);
            color: var(--gold);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--gold);
            position: relative;
        }

        .header-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-icon {
            background: var(--gold);
            color: var(--dark-blue);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .header-btn {
            padding: 6px 14px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            border: 2px solid var(--gold);
            background: transparent;
            color: var(--gold);
            transition: all 0.2s;
            border-radius: 4px;
        }

        .header-btn:hover {
            background: var(--gold);
            color: var(--dark-blue);
            transform: translateY(-2px);
        }

        .header-btn.dashboard {
            background: var(--dashboard-green);
            color: white;
            border-color: transparent;
            border-radius: 4px;
        }

        .header-btn.dashboard:hover {
            background: #2e7d32;
        }

        .header-btn.reset {
            background: var(--reset-red);
            color: white;
            border-color: transparent;
            border-radius: 4px;
        }

        .header-btn.reset:hover {
            background: var(--reset-red-dark);
        }

        .header-btn.pdf {
            background: var(--pdf-grey);
            color: white;
            border-color: transparent;
            border-radius: 4px;
        }

        .header-btn.pdf:hover {
            background: var(--pdf-grey-dark);
        }

        /* Menu toggle - hidden by default on desktop */
        .menu-toggle {
            display: none;
        }

        .password-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .password-container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            border: 3px solid var(--gold);
            max-width: 380px;
            width: 90%;
            text-align: center;
        }

        .password-container h1 {
            font-family: 'Playfair Display', serif;
            color: var(--dark-blue);
            font-size: 24px;
            margin-bottom: 8px;
        }

        .password-wrapper {
            position: relative;
            margin: 20px 0;
        }

        .password-wrapper input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gold);
            border-radius: 4px;
            font-size: 15px;
            outline: none;
        }

        .toggle-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--maroon);
            font-weight: bold;
            font-size: 13px;
        }

        .unlock-btn {
            background: var(--maroon);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            font-size: 15px;
        }

        .error-msg {
            color: var(--maroon);
            margin-top: 12px;
            display: none;
            font-size: 13px;
        }

        .footer-note {
            margin-top: 25px;
            font-size: 11px;
            color: #666;
        }

        .blinking-text {
            color: var(--maroon);
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #fffcf8;
        }

        #dashboardSection {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dashboard-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 900px;
            width: 100%;
            padding: 20px;
        }

        .top-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .bottom-row {
            display: flex;
            justify-content: center;
        }

        .dashboard-card {
            background: white;
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 10px rgba(0,0,0,0.03);
            height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .dashboard-card:hover {
            transform: translateY(-3px);
            border-color: var(--bronze);
            box-shadow: 0 8px 15px rgba(188, 140, 79, 0.1);
        }

        .bottom-card {
            width: 70%;
            height: 60px;
            background: #991b1b;
            color: white;
            border: 2px solid #991b1b;
            padding: 10px;
        }

        .bottom-card:hover {
            background: #b91c1c;
        }

        .card-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 5px;
        }

        .card-desc {
            color: #666;
            font-size: 11px;
        }

        .data-status {
            margin-top: 8px;
            color: var(--maroon);
            font-size: 10px;
            font-weight: 600;
        }

        #individualSection, #rootSection {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            flex: 1;
        }

        .fixed-header-section {
            padding: 15px 15px 0 15px;
            background: #fffcf8;
            flex-shrink: 0;
        }

        .border-line {
            border-top: 3px solid var(--gold);
            margin: 20px 0 0 0;
        }

        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            padding: 0 15px 15px 15px;
        }

        .search-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-label {
            font-weight: 700;
            color: var(--maroon);
            font-size: 13px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .search-wrapper {
            position: relative;
            flex: 2;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 8px 15px;
            border: 2px solid #cbd5e1;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }

        .root-search-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .root-search-input {
            width: 650px;
            padding: 8px 15px;
            border: 2px solid #cbd5e1;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
        }

        .root-search-input:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }

        .filter-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 14px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            border: 2px solid var(--gold);
            background: white;
            color: var(--dark-blue);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .filter-btn.active {
            background: #d4edda;
            border-color: var(--dark-green);
        }

        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--gold);
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .result-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 13px;
        }

        .result-item:hover {
            background: #faebcd;
        }

        .result-item .main-name {
            font-weight: 700;
            color: var(--dark-blue);
        }

        .result-item .gen {
            color: var(--maroon);
            font-size: 11px;
            margin-left: 6px;
        }

        .tree-root-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: fit-content;
            margin: 0 auto;
            padding: 15px;
        }

        .family-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .children-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 5px;
        }

        .relation-label {
            font-size: 11px;
            color: var(--gold);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--dark-blue);
            padding: 4px 12px;
            border-radius: 4px;
            color: white;
            margin: 5px 0;
            text-align: center;
            display: inline-block;
            width: auto;
        }

        .sisters-group-box {
            border: 2px solid var(--sisters-border);
            border-radius: 12px;
            background: var(--sisters-box-bg);
            min-width: 300px;
            max-width: 380px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            padding: 12px;
            margin: 10px auto;
        }

        .sisters-group-box .sisters-header {
            font-size: 14px;
            font-weight: 800;
            color: var(--maroon);
            padding-bottom: 6px;
            margin-bottom: 6px;
            text-align: left;
            border-bottom: 2px solid var(--sisters-border);
            font-family: 'Playfair Display', serif;
        }

        .sisters-group-box table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
        }

        .sisters-group-box th {
            text-align: left;
            padding: 4px 8px;
            font-size: 11px;
            color: var(--maroon);
            border-bottom: 1px solid var(--sisters-border);
        }

        .sisters-group-box td {
            padding: 4px 8px;
            border-bottom: 1px dashed #fecaca;
        }

        .sisters-group-box td:first-child {
            font-weight: 600;
            text-align: left;
        }

        .sisters-group-box td:last-child {
            text-align: right;
            color: var(--maroon);
        }

        .sisters-group-box .sister-father {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px dotted var(--sisters-border);
            text-align: center;
            font-style: italic;
        }

        .box {
            border: 2px solid var(--gold);
            border-radius: 12px;
            background: white;
            min-width: 240px;
            max-width: 280px;
            text-align: center;
            cursor: pointer;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .box:hover {
            transform: translateY(-3px);
        }

        .box.blinking-box {
            animation: blinkBoxLightGreen 1.5s infinite;
            border-width: 4px;
            z-index: 10;
            transform: scale(1.02);
        }

        @keyframes blinkBoxLightGreen {
            0%, 100% { 
                border-color: #2e7d32;
                background: #e8f5e9;
                box-shadow: 0 0 15px rgba(46, 125, 50, 0.4);
            }
            50% { 
                border-color: #4caf50;
                background: #c8e6c9;
                box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
                transform: scale(1.05);
            }
        }

        .box-header {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            background: #f8fafc;
            font-size: 10px;
            font-weight: 800;
            border-bottom: 1px solid #ddd;
        }

        .lineage-header {
            background: linear-gradient(135deg, var(--gold) 0%, var(--light-gold) 100%);
        }

        .box-body {
            padding: 12px;
        }

        .member-name {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 16px;
            display: block;
        }

        .father-name {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .female-box {
            background-color: var(--pink-bg) !important;
            border-color: #fb7185 !important;
        }

        .v-line {
            width: 3px;
            height: 25px;
            background: var(--gold);
            margin: 5px auto;
        }

        .h-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .golden-heart {
            position: absolute;
            bottom: 5px;
            right: 8px;
            color: var(--gold);
            font-size: 16px;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 15px;
            margin: 0 auto;
            width: fit-content;
            max-width: 100%;
        }

        .lineage-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
            font-size: 13px;
            margin: 0 auto 20px auto;
        }

        .lineage-table:last-child {
            margin-bottom: 0;
        }

        .lineage-table th {
            background: #fdf6e3;
            padding: 8px;
            border-bottom: 2px solid var(--gold);
            text-align: center;
        }

        .lineage-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #f0e5ce;
            text-align: center;
        }

        .lineage-table tr.female-row {
            background-color: var(--pink-bg) !important;
        }
        
        .lineage-table tr.female-row:hover {
            background-color: #ffe4e6 !important;
        }
        
        .lineage-table tr:hover {
            background-color: #faebcd;
        }

        .root-announce {
            background: var(--light-sage);
            padding: 15px 25px;
            border-radius: 30px;
            margin: 20px auto;
            text-align: center;
            border: 2px solid var(--border-sage);
            width: fit-content;
            max-width: 600px;
        }

        .generation-info {
            background: white;
            border-radius: 20px;
            padding: 12px;
            margin-top: 12px;
            border: 1px solid var(--border-sage);
        }

        .gap-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .gap-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: var(--light-sage);
            border-radius: 40px;
            border: 1px solid var(--border-sage);
            font-size: 12px;
        }

        .gap-value {
            font-weight: 700;
            background: white;
            padding: 2px 8px;
            border-radius: 30px;
        }

        .gap-value.highlight {
            background: var(--bronze);
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .app-footer {
            background: var(--dark-blue);
            color: var(--gold);
            text-align: center;
            padding: 8px;
            font-size: 11px;
            border-top: 2px solid var(--gold);
        }

        .exit-btn-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #991b1b;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid #991b1b;
            white-space: nowrap;
            width: 70%;
            justify-content: center;
        }

        .exit-btn-container:hover {
            background: #b91c1c;
        }

        .exit-btn-icon {
            font-size: 18px;
        }

        .exit-btn-text {
            font-weight: 700;
            font-size: 13px;
        }

        .exit-btn-subtext {
            font-size: 10px;
            color: #fecaca;
        }

        .toggle-view-btn {
            position: fixed; bottom: 20px; left: 20px; z-index: 9999;
            background: #5a0000; color: white; border: 2px solid #d4af37;
            border-radius: 50px; padding: 10px 20px; font-size: 14px;
            font-weight: bold; cursor: pointer; display: flex; align-items: center;
            gap: 8px; opacity: 0.8;
        }
        .toggle-view-btn:hover {
            opacity: 1;
        }
        body.canvas-only .app-header,
        body.canvas-only .app-footer,
        body.canvas-only .fixed-header-section,
        body.canvas-only .filter-buttons,
        body.canvas-only .search-row,
        body.canvas-only .root-search-row,
        body.canvas-only .border-line,
        body.canvas-only .dashboard-grid,
        body.canvas-only .exit-btn-container {
            display: none !important;
        }
        body.canvas-only .main-content {
            height: 100vh;
        }

        /* ========== DESKTOP FIRST - FORCE PC STYLES ========== */
        @media screen and (min-width: 769px) {
            /* Force desktop styles - these will always apply on PC */
            .menu-toggle {
                display: none !important;
            }
            
            .fixed-header-section {
                max-height: none !important;
                padding: 15px 15px 0 15px !important;
            }
            
            .fixed-header-section.collapsed {
                max-height: none !important;
                padding: 15px 15px 0 15px !important;
            }
            
            .search-row {
                flex-direction: row !important;
            }
            
            .root-search-row {
                flex-direction: row !important;
            }
            
            .search-wrapper {
                min-width: 300px !important;
            }
            
            .search-input, .root-search-input {
                width: 100% !important;
                font-size: 13px !important;
                padding: 8px 15px !important;
                height: auto !important;
            }
            
            .filter-buttons {
                width: auto !important;
            }
            
            .filter-btn {
                flex: none !important;
                width: auto !important;
                padding: 6px 14px !important;
                font-size: 13px !important;
            }
            
            .header-actions {
                width: auto !important;
            }
            
            .header-btn {
                flex: none !important;
                width: auto !important;
                padding: 6px 14px !important;
                font-size: 13px !important;
                height: auto !important;
            }
            
            .top-row {
                grid-template-columns: repeat(3, 1fr) !important;
            }
            
            .dashboard-card {
                height: 140px !important;
                padding: 20px 10px !important;
            }
            
            .card-icon {
                font-size: 36px !important;
            }
            
            .card-title {
                font-size: 16px !important;
            }
            
            .exit-btn-container {
                width: 70% !important;
                height: auto !important;
                padding: 8px 16px !important;
            }
            
            .box {
                min-width: 240px !important;
                max-width: 280px !important;
            }
            
            .member-name {
                font-size: 16px !important;
            }
            
            .sisters-group-box {
                min-width: 300px !important;
                max-width: 380px !important;
            }
            
            .scrollable-content {
                overflow-y: auto !important;
                padding: 0 15px 15px 15px !important;
            }
            
            .main-content {
                overflow: hidden !important;
            }
            
            #individualSection, #rootSection {
                overflow: hidden !important;
            }
            
            .table-container {
                width: fit-content !important;
            }
            
            .lineage-table {
                min-width: 500px !important;
            }
            
            .root-announce {
                width: fit-content !important;
            }
            
            .gap-row {
                flex-direction: row !important;
            }
            
            .gap-item {
                width: auto !important;
            }
        }

        /* ========== MOBILE OPTIMIZATIONS - TOUCH DEVICES ONLY ========== */
        @media screen and (max-width: 768px) and (hover: none) and (pointer: coarse) {
            body {
                overflow: auto;
                -webkit-overflow-scrolling: touch;
                height: auto;
                min-height: 100vh;
                padding: 5px;
            }
            
            .app-container {
                height: auto;
                min-height: calc(100vh - 10px);
                border-radius: 16px;
                overflow: hidden;
            }
            
            .app-header {
                position: relative;
                padding: 10px 15px;
            }
            
            .header-title {
                font-size: 18px;
                width: calc(100% - 50px);
            }
            
            .menu-toggle {
                display: flex !important;
                position: absolute;
                top: 50%;
                right: 15px;
                transform: translateY(-50%);
                background: var(--gold);
                color: black;
                border: none;
                border-radius: 50%;
                width: 44px;
                height: 44px;
                font-size: 26px;
                font-weight: bold;
                cursor: pointer;
                z-index: 2000;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
            
            .fixed-header-section {
                transition: max-height 0.3s ease, padding 0.3s ease, margin 0.3s ease;
                overflow: hidden;
                max-height: 500px;
                padding: 15px 15px 10px 15px;
                background: #fffcf8;
            }
            
            .fixed-header-section.collapsed {
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
                margin: 0;
                border-bottom: none;
            }
            
            .search-row {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .root-search-row {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .search-wrapper {
                min-width: 100%;
                width: 100%;
            }
            
            .search-input, .root-search-input {
                width: 100%;
                font-size: 16px;
                padding: 12px 15px;
                height: 48px;
            }
            
            .filter-buttons {
                width: 100%;
                justify-content: space-between;
                gap: 8px;
            }
            
            .filter-btn {
                flex: 1;
                padding: 10px 5px;
                font-size: 12px;
                justify-content: center;
                height: 44px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
                gap: 5px;
            }
            
            .header-btn {
                flex: 1;
                padding: 10px 5px;
                font-size: 11px;
                justify-content: center;
                height: 44px;
                white-space: nowrap;
            }
            
            .top-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .dashboard-card {
                height: 110px;
                padding: 15px 10px;
            }
            
            .card-icon {
                font-size: 32px;
            }
            
            .card-title {
                font-size: 16px;
            }
            
            .card-desc {
                font-size: 12px;
            }
            
            .exit-btn-container {
                width: 100%;
                height: 50px;
                padding: 12px;
                font-size: 14px;
            }
            
            .box {
                min-width: 200px;
                max-width: 260px;
                margin: 0 auto;
            }
            
            .member-name {
                font-size: 18px !important;
            }
            
            .father-name {
                font-size: 11px;
            }
            
            .children-row {
                gap: 12px;
            }
            
            .sisters-group-box {
                min-width: 240px;
                max-width: 300px;
                width: 100%;
                margin: 8px auto;
            }
            
            .v-line {
                height: 20px;
            }
            
            .relation-label {
                font-size: 11px;
                padding: 5px 15px;
            }
            
            .scrollable-content {
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
                padding: 0 12px 20px 12px;
            }
            
            #individualSection, #rootSection {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .main-content {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
                padding: 10px;
            }
            
            .lineage-table {
                min-width: 500px;
            }
            
            .root-announce {
                width: 100%;
                padding: 15px;
                margin: 15px 0;
            }
            
            .gap-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .gap-item {
                width: 100%;
                justify-content: space-between;
            }
            
            .toggle-view-btn {
                bottom: 15px;
                left: 15px;
                padding: 10px 18px;
                font-size: 14px;
                height: 48px;
                opacity: 0.95;
            }
            
            .dropdown {
                max-height: 200px;
                font-size: 14px;
            }
            
            .result-item {
                padding: 12px 15px;
            }
            
            .app-footer {
                padding: 10px;
                font-size: 10px;
            }
        }

        /* Tablet fallback */
        @media screen and (max-width: 768px) and (hover: hover) {
            /* For small screens with mouse (like some tablets in desktop mode) */
            .menu-toggle {
                display: none !important;
            }
        }

        @media screen and (max-width: 380px) and (hover: none) and (pointer: coarse) {
            .box {
                min-width: 160px;
                max-width: 220px;
            }
            
            .member-name {
                font-size: 16px !important;
            }
            
            .filter-btn {
                font-size: 11px;
                padding: 8px 4px;
            }
            
            .header-btn {
                font-size: 10px;
                padding: 8px 4px;
            }
        }

        @media (max-width: 900px) {
            .top-row {
                grid-template-columns: repeat(2, 1fr);
            }
            .bottom-card {
                width: 66.666%;
            }
            .root-search-input {
                width: 100%;
            }
        }

        @media (max-width: 600px) {
            .top-row {
                grid-template-columns: 1fr;
            }
            .bottom-card {
                width: 100%;
            }
            .search-row {
                flex-direction: column;
                align-items: stretch;
            }
            .root-search-row {
                flex-direction: column;
                align-items: stretch;
            }
            .root-search-input {
                width: 100%;
            }
        }
   
/* Allow zoom out on mobile */
@media screen and (max-width: 768px) {
    body {
        overflow-x: auto !important;
        -webkit-text-size-adjust: 100%;
    }
    
    .app-container {
        width: 100% !important;
        min-width: 320px !important;
        max-width: 100% !important;
        transform-origin: top left;
    }
    
    .fixed-header-section,
    .scrollable-content,
    .tree-root-layout,
    .table-container {
        max-width: 100% !important;
        overflow-x: auto !important;
    }
    
    .box, .sisters-group-box {
        max-width: 100% !important;
        min-width: 160px !important;
    }
}

 </style>
</head>
<body>
    <div id="passwordScreen" class="password-screen">
        <div class="password-container">
            <h1>Rizvi Family Tree</h1>
            <p>Honoring our past, preserving our future.</p>
            
            <div class="password-wrapper">
                <input type="password" id="passwordField" placeholder="Enter Secure Password">
                <span class="toggle-btn" onclick="togglePassword()">Show</span>
            </div>

            <button onclick="checkPassword()" class="unlock-btn">Unlock Dashboard</button>
            <div id="passwordError" class="error-msg">Access Denied. Please verify the password.</div>

            <div class="footer-note">
                <p>Designed by:</p>
                <p><strong>Imran Haider S/o Syed Risalat Hussain Rizvi | 0332-787-6010</strong></p>
                <p class="blinking-text">‚ö†Ô∏è Private family access only ‚ö†Ô∏è</p>
            </div>
        </div>
    </div>

    <div id="mainApp" class="app-container" style="display: none;">
        <div class="app-header">
            <div class="header-title">
                <span class="header-icon">üåø</span>
                <span id="mainTitle">Rizvi Family Dashboard</span>
            </div>
            <button class="menu-toggle" id="mobileMenuToggle">‚ò∞</button>
            <div class="header-actions" id="headerActions"></div>
        </div>

        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none;">

        <div class="main-content" id="mainContent">
            <div id="dashboardSection">
                <div class="dashboard-grid">
                    <div class="top-row">
                        <div class="dashboard-card" onclick="loadDataWithPassword()">
                            <div class="card-icon">üìÇ</div>
                            <div class="card-title">Load Data</div>
                            <div class="card-desc">Upload Excel file</div>
                            <div class="data-status" id="dataStatus">No data</div>
                        </div>
                        <div class="dashboard-card" onclick="showIndividualSearch()">
                            <div class="card-icon">üë§</div>
                            <div class="card-title">Individual</div>
                            <div class="card-desc">Single member search</div>
                        </div>
                        <div class="dashboard-card" onclick="showRootSearch()">
                            <div class="card-icon">üë•</div>
                            <div class="card-title">Root Relative</div>
                            <div class="card-desc">Two member search</div>
                        </div>
                    </div>
                    <div class="bottom-row">
                        <div class="exit-btn-container" onclick="logout()">
                            <span class="exit-btn-icon">üö™</span>
                            <span class="exit-btn-text">Exit</span>
                            <span class="exit-btn-subtext">- (Back to login)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="individualSection" class="hidden">
                <div class="fixed-header-section">
                    <div class="search-row">
                        <span class="search-label">SEARCH MEMBER</span>
                        <div class="search-wrapper">
                            <input type="text" id="individualSearch" class="search-input" placeholder="Type name..." onkeyup="searchIndividual(this.value)" autocomplete="off">
                            <div id="individualDropdown" class="dropdown"></div>
                        </div>
                        <div class="filter-buttons">
                            <div id="filterSiblings" class="filter-btn active" onclick="toggleFilter('siblings')">üë• Siblings</div>
                            <div id="filterDescendants" class="filter-btn active" onclick="toggleFilter('descendants')">üë∂ Descendants</div>
                            <div id="filterAncestors" class="filter-btn" onclick="toggleFilter('ancestors')">üå≥ Ancestors</div>
                        </div>
                    </div>
                    <div class="border-line"></div>
                </div>
                <div class="scrollable-content">
                    <div id="individualTree" class="tree-root-layout"></div>
                    <div id="individualTable" class="table-container hidden"></div>
                </div>
            </div>

            <div id="rootSection" class="hidden">
                <div class="fixed-header-section">
                    <div class="root-search-row">
                        <span class="search-label">MEMBER 1</span>
                        <div class="search-wrapper" style="width:650px;">
                            <input type="text" id="rootSearch1" class="root-search-input" placeholder="Type name..." onkeyup="searchRootMember(this.value, 1)" autocomplete="off">
                            <div id="rootDropdown1" class="dropdown"></div>
                        </div>
                    </div>
                    <div class="root-search-row">
                        <span class="search-label">MEMBER 2</span>
                        <div class="search-wrapper" style="width:650px;">
                            <input type="text" id="rootSearch2" class="root-search-input" placeholder="Type name..." onkeyup="searchRootMember(this.value, 2)" autocomplete="off">
                            <div id="rootDropdown2" class="dropdown"></div>
                        </div>
                    </div>
                    <div class="border-line"></div>
                </div>
                <div class="scrollable-content">
                    <div id="rootContent"></div>
                </div>
            </div>
        </div>

        <div class="app-footer">
            Imran Haider S/o Syed Risalat Hussain Rizvi | 0332-787-6010
        </div>
    </div>

    <div class="toggle-view-btn" id="toggleViewBtn" onclick="toggleCanvasView()">
        <span>üëÅÔ∏è</span> <span>Full Screen</span>
    </div>

    <script>
        // ======================================================================
        // ========================== CONFIG SECTION ============================
        // ======================================================================
        const CONFIG = {
            password: 'sihr110',
            dataPassword: '6010'
        };

        // ======================================================================
        // ========================== GLOBAL VARIABLES ==========================
        // ======================================================================
        let db = [];
        let currentIndividual = null;
        let rootMember1 = null;
        let rootMember2 = null;
        let individualView = 'tree';
        let rootView = 'tree';
        let showSiblings = true;
        let showDescendants = true;
        let showAncestors = false;
        let LOAD_STAMP = '';

        // ======================================================================
        // ========================== HELPER FUNCTIONS ==========================
        // ======================================================================
        function displayName(str) {
            return str ? str.replace(/\s*-\s*\d+$/, '').trim() : '';
        }

        function properCase(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        }

        function formatCurrentTime() {
            const d = new Date();
            const day = d.getDate();
            const month = d.getMonth() + 1;
            const year = d.getFullYear();
            const hours = d.getHours();
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'pm' : 'am';
            const displayHours = hours % 12 || 12;
            return `${day}/${month}/${year} - ${displayHours}:${minutes}${ampm}`;
        }

        function formatH2Value(raw) {
            if (!raw) return "No timestamp";
            const d = new Date(raw);
            if (isNaN(d)) return raw;
            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            const day = d.getDate();
            const year = d.getFullYear();
            const hours = d.getHours();
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'pm' : 'am';
            const displayHours = hours % 12 || 12;
            return `${months[d.getMonth()]} ${day}.${year} - ${displayHours}:${minutes} ${ampm}`;
        }

        function getTimestampFromExcel(wb) {
            try {
                const cell = wb.Sheets[wb.SheetNames[0]]['H2'];
                const dateStr = cell ? formatH2Value(cell.w || cell.v) : "No timestamp";
                return `Last data updated on ${dateStr}`;
            } catch { 
                return "Last data updated on: Unknown date"; 
            }
        }

        // ======================================================================
        // ========================== 1- DASHBOARD SECTION =====================
        // ======================================================================
        function showDashboard() {
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('individualSection').classList.add('hidden');
            document.getElementById('rootSection').classList.add('hidden');
            document.getElementById('mainTitle').innerText = 'Rizvi Family Dashboard';
            updateHeaderButtons('dashboard');
        }

        function showIndividualSearch() {
            if (!db.length) {
                alert('Please load data first');
                return;
            }
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('individualSection').classList.remove('hidden');
            document.getElementById('rootSection').classList.add('hidden');
            document.getElementById('mainTitle').innerText = 'Rizvi Family - Individual Search';
            updateHeaderButtons('individual');
            
            document.getElementById('individualSearch').value = '';
            currentIndividual = null;
            
            document.getElementById('individualTree').innerHTML = '<div style="text-align:center; color:#999; padding:60px;">Select a member to view</div>';
            document.getElementById('individualTable').classList.add('hidden');
            document.getElementById('individualTree').classList.remove('hidden');
            individualView = 'tree';
        }

        function showRootSearch() {
            if (!db.length) {
                alert('Load data first');
                return;
            }
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('individualSection').classList.add('hidden');
            document.getElementById('rootSection').classList.remove('hidden');
            document.getElementById('mainTitle').innerText = 'Rizvi Family - Search Root Relative';
            updateHeaderButtons('root');
            
            rootMember1 = null;
            rootMember2 = null;
            document.getElementById('rootSearch1').value = '';
            document.getElementById('rootSearch2').value = '';
            document.getElementById('rootContent').innerHTML = '<div style="text-align:center; color:#999; padding:60px;">Select two members to view relationship</div>';
        }

        function updateHeaderButtons(section) {
            const headerActions = document.getElementById('headerActions');
            headerActions.innerHTML = '';
            
            if (section === 'individual') {
                const viewText = individualView === 'tree' ? 'üìã Switch to Table' : 'üå≤ Switch to Tree';
                headerActions.innerHTML = `
                    <div class="header-btn" onclick="toggleIndividualView()">${viewText}</div>
                    <div class="header-btn reset" onclick="resetIndividual()">üîÑ Reset</div>
                    <div class="header-btn pdf" onclick="exportIndividualPDF()">üìë Save PDF</div>
                    <div class="header-btn dashboard" onclick="showDashboard()">üè† Dashboard</div>
                `;
            } else if (section === 'root') {
                const viewText = rootView === 'tree' ? 'üìã Switch to Table' : 'üå≤ Switch to Tree';
                headerActions.innerHTML = `
                    <div class="header-btn" onclick="toggleRootView()">${viewText}</div>
                    <div class="header-btn reset" onclick="resetRoot()">üîÑ Reset</div>
                    <div class="header-btn pdf" onclick="exportRootPDF()">üìë Save PDF</div>
                    <div class="header-btn dashboard" onclick="showDashboard()">üè† Dashboard</div>
                `;
            } else {
                headerActions.innerHTML = '';
            }
        }

        // ======================================================================
        // ========================== 2- RESET FUNCTIONS =======================
        // ======================================================================
        function resetIndividual() {
            document.getElementById('individualSearch').value = '';
            currentIndividual = null;
            document.getElementById('individualTree').innerHTML = '<div style="text-align:center; color:#999; padding:60px;">Select a member to view</div>';
            document.getElementById('individualTable').innerHTML = '';
            if (individualView === 'table') {
                document.getElementById('individualTree').classList.remove('hidden');
                document.getElementById('individualTable').classList.add('hidden');
                individualView = 'tree';
                updateHeaderButtons('individual');
            }
        }

        function resetRoot() {
            rootMember1 = null;
            rootMember2 = null;
            document.getElementById('rootSearch1').value = '';
            document.getElementById('rootSearch2').value = '';
            document.getElementById('rootContent').innerHTML = '<div style="text-align:center; color:#999; padding:60px;">Select two members to view relationship</div>';
        }

        // ======================================================================
        // ========================== 3- VIEW TOGGLE FUNCTIONS =================
        // ======================================================================
        function toggleIndividualView() {
            if (!currentIndividual) return;
            individualView = individualView === 'tree' ? 'table' : 'tree';
            updateHeaderButtons('individual');
            renderIndividualView();
        }

        function toggleRootView() {
            rootView = rootView === 'tree' ? 'table' : 'tree';
            updateHeaderButtons('root');
            if (rootMember1 && rootMember2) {
                if (rootView === 'tree') renderRootTree();
                else renderRootTable();
            }
        }

        // ======================================================================
        // ========================== 4- FILTER TOGGLE FUNCTION ================
        // ======================================================================
        function toggleFilter(filter) {
            if (!currentIndividual) return;
            
            if (filter === 'siblings') {
                showSiblings = !showSiblings;
                document.getElementById('filterSiblings').classList.toggle('active', showSiblings);
            } else if (filter === 'descendants') {
                showDescendants = !showDescendants;
                document.getElementById('filterDescendants').classList.toggle('active', showDescendants);
            } else if (filter === 'ancestors') {
                showAncestors = !showAncestors;
                document.getElementById('filterAncestors').classList.toggle('active', showAncestors);
            }
            
            renderIndividualView();
        }

        // ======================================================================
        // ========================== 5- TREE FUNCTIONS ========================
        // ======================================================================
        function findParent(p) {
            if (!p || !p.father) return null;
            return db.find(x => x.name.toLowerCase() === p.father.toLowerCase());
        }

        function getGenNum(gen) {
            const match = String(gen).match(/\d+/);
            return match ? parseInt(match[0]) : 0;
        }

        function getAncestryChain(p) {
            if (!p) return [];
            let chain = [], cur = p, visited = new Set();
            while (cur && !visited.has(cur.name.toLowerCase())) {
                chain.push(cur);
                visited.add(cur.name.toLowerCase());
                cur = findParent(cur);
            }
            return chain;
        }

        function findCommonRoot(m1, m2) {
            const chain1 = getAncestryChain(m1);
            const chain2 = getAncestryChain(m2);
            
            for (let p of chain1) {
                if (chain2.some(x => x.name.toLowerCase() === p.name.toLowerCase())) {
                    return p;
                }
            }
            return null;
        }

        // ======================================================================
        // ========================== 6- SEARCH FUNCTIONS ======================
        // ======================================================================
        function searchIndividual(query) {
            if (!db.length) return;
            
            const drop = document.getElementById('individualDropdown');
            performSearch(query, drop, (member) => {
                document.getElementById('individualSearch').value = displayName(member.name) + ' (' + member.gen + ')';
                currentIndividual = member;
                renderIndividualView();
                drop.style.display = 'none';
            });
        }

        function searchRootMember(query, num) {
            if (!db.length) return;
            
            const drop = document.getElementById(`rootDropdown${num}`);
            performSearch(query, drop, (member) => {
                document.getElementById(`rootSearch${num}`).value = displayName(member.name) + ' (' + member.gen + ')';
                if (num === 1) rootMember1 = member;
                else rootMember2 = member;
                
                if (rootMember1 && rootMember2) {
                    if (rootView === 'tree') renderRootTree();
                    else renderRootTable();
                }
                drop.style.display = 'none';
            });
        }

        function performSearch(query, drop, callback) {
            if (!drop) return;
            
            drop.innerHTML = '';
            if (!query || query.length < 1) {
                drop.style.display = 'none';
                return;
            }
            
            const found = db.filter(p => p.name.toLowerCase().includes(query.toLowerCase())).slice(0, 8);
            if (found.length === 0) {
                drop.style.display = 'none';
                return;
            }
            
            found.forEach(p => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `<div><span class="main-name">${displayName(p.name)}</span> <span class="gen">(${p.gen})</span></div>
                    <div style="font-size:11px;">${p.gender?.startsWith('F') ? 'D/o' : 'S/o'} ${displayName(p.father)}</div>`;
                div.onclick = (e) => {
                    e.stopPropagation();
                    callback(p);
                };
                drop.appendChild(div);
            });
            
            drop.style.display = 'block';
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-wrapper')) {
                document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
            }
        });

        function handleBoxClick(member) {
            if (!member || !member.name) return;
            
            if (!document.getElementById('individualSection').classList.contains('hidden')) {
                currentIndividual = member;
                document.getElementById('individualSearch').value = displayName(member.name) + ' (' + member.gen + ')';
                renderIndividualView();
            } else if (!document.getElementById('rootSection').classList.contains('hidden')) {
                if (!rootMember1) {
                    rootMember1 = member;
                    document.getElementById('rootSearch1').value = displayName(member.name) + ' (' + member.gen + ')';
                } else if (!rootMember2) {
                    rootMember2 = member;
                    document.getElementById('rootSearch2').value = displayName(member.name) + ' (' + member.gen + ')';
                    
                    if (rootView === 'tree') renderRootTree();
                    else renderRootTable();
                }
            }
        }

        function groupSisters(sistersArray, fatherName, type) {
            if (!sistersArray || sistersArray.length === 0) return '';
            
            let headerText = type === 'siblings' ? 'SISTERS' : 'DAUGHTERS';
            
            let html = `<div class="sisters-group-box">`;
            html += `<div class="sisters-header"># ${headerText}</div>`;
            
            html += `<table style="width:100%; border-collapse: collapse; margin: 8px 0;">`;
            html += `<tr style="border-bottom: 1px solid var(--sisters-border);">`;
            html += `<th style="text-align: left; padding: 4px 8px; font-size: 11px; color: var(--maroon);">Name</th>`;
            html += `<th style="text-align: right; padding: 4px 8px; font-size: 11px; color: var(--maroon);">Gen</th>`;
            html += `</tr>`;
            
            sistersArray.forEach(sister => {
                const memberData = encodeURIComponent(JSON.stringify(sister));
                html += `<tr onclick='handleBoxClick(JSON.parse(decodeURIComponent("${memberData}")))' style="cursor: pointer;">`;
                html += `<td style="padding: 4px 8px; border-bottom: 1px dashed #fecaca; font-weight: 600; transition: background 0.2s;" 
                          onmouseover="this.style.background='#faebcd'" 
                          onmouseout="this.style.background='transparent'">${displayName(sister.name)}</td>`;
                html += `<td style="padding: 4px 8px; border-bottom: 1px dashed #fecaca; text-align: right; color: var(--maroon); 
                          transition: background 0.2s;"
                          onmouseover="this.style.background='#faebcd'" 
                          onmouseout="this.style.background='transparent'">${sister.gen}</td>`;
                html += `</tr>`;
            });
            
            html += `</table>`;
            html += `<div class="sister-father">*D/o ${displayName(fatherName)}*</div>`;
            html += `</div>`;
            
            return html;
        }

        // ======================================================================
        // ========================== 7- RENDER FUNCTIONS ======================
        // ======================================================================
        function renderIndividualView() {
            if (!currentIndividual) return;
            
            if (individualView === 'tree') {
                document.getElementById('individualTree').classList.remove('hidden');
                document.getElementById('individualTable').classList.add('hidden');
                renderIndividualTree();
            } else {
                document.getElementById('individualTree').classList.add('hidden');
                document.getElementById('individualTable').classList.remove('hidden');
                renderIndividualTable();
            }
        }

        function renderIndividualTree() {
            if (!currentIndividual) return;
            
            let html = '<div>';
            
            if (showAncestors) {
                const ancestors = getAncestryChain(currentIndividual).slice(1);
                if (ancestors.length > 0) {
                    html += '<div class="family-group">';
                    html += '<div class="relation-label">ANCESTORS</div>';
                    [...ancestors].reverse().forEach((a, idx) => {
                        const hasChildren = db.some(x => x.father && x.father.toLowerCase() === a.name.toLowerCase());
                        html += renderBox(a, idx === 0 ? 'Earliest' : 'Ancestor', false, hasChildren);
                        if (idx < ancestors.length - 1) html += '<div class="v-line"></div>';
                    });
                    html += '<div class="v-line"></div>';
                    html += '</div>';
                }
            }
            
            const father = findParent(currentIndividual);
            
            if (father) {
                const fatherHasChildren = db.some(x => x.father && x.father.toLowerCase() === father.name.toLowerCase());
                html += '<div class="family-group">';
                html += renderBox(father, 'Father', false, fatherHasChildren);
                html += '<div class="v-line"></div>';
                
                const currentHasChildren = db.some(x => x.father && x.father.toLowerCase() === currentIndividual.name.toLowerCase());
                html += renderBox(currentIndividual, 'Selected', true, currentHasChildren);
                html += '</div>';
            } else {
                const currentHasChildren = db.some(x => x.father && x.father.toLowerCase() === currentIndividual.name.toLowerCase());
                html += '<div class="family-group">';
                html += renderBox(currentIndividual, 'Selected', true, currentHasChildren);
                html += '</div>';
            }
            
            if (showSiblings && father) {
                const siblings = db.filter(s => s.father && s.father.toLowerCase() === currentIndividual.father.toLowerCase() && s.name !== currentIndividual.name);
                
                if (siblings.length > 0) {
                    const maleSiblings = siblings.filter(s => !s.gender?.startsWith('F'));
                    const femaleSiblings = siblings.filter(s => s.gender?.startsWith('F'));
                    
                    html += '<div class="family-group">';
                    html += '<div class="relation-label">SIBLINGS</div>';
                    
                    if (maleSiblings.length > 0) {
                        html += '<div class="children-row">';
                        maleSiblings.forEach(s => {
                            const hasChildren = db.some(x => x.father && x.father.toLowerCase() === s.name.toLowerCase());
                            html += renderBox(s, 'Brother', false, hasChildren);
                        });
                        html += '</div>';
                    }
                    
                    if (femaleSiblings.length > 0) {
                        html += groupSisters(femaleSiblings, father.name, 'siblings');
                    }
                    
                    html += '</div>';
                }
            }
            
            if (showDescendants) {
                const children = db.filter(c => c.father && c.father.toLowerCase() === currentIndividual.name.toLowerCase());
                if (children.length > 0) {
                    const maleChildren = children.filter(c => !c.gender?.startsWith('F'));
                    const femaleChildren = children.filter(c => c.gender?.startsWith('F'));
                    
                    html += '<div class="family-group">';
                    html += '<div class="v-line"></div>';
                    html += '<div class="relation-label">CHILDREN</div>';
                    
                    if (maleChildren.length > 0) {
                        html += '<div class="children-row">';
                        maleChildren.forEach(c => {
                            const hasChildren = db.some(x => x.father && x.father.toLowerCase() === c.name.toLowerCase());
                            html += renderBox(c, 'Son', false, hasChildren);
                        });
                        html += '</div>';
                    }
                    
                    if (femaleChildren.length > 0) {
                        html += groupSisters(femaleChildren, currentIndividual.name, 'children');
                    }
                    
                    html += '</div>';
                }
            }
            
            html += '</div>';
            document.getElementById('individualTree').innerHTML = html;
        }

        function renderIndividualTable() {
            if (!currentIndividual) return;
            
            let html = '<div class="table-container">';
            
            // Main Member Table
            html += `<table class="lineage-table" style="margin-bottom: 20px;">`;
            html += `<tr><th colspan="3" style="background: linear-gradient(135deg, var(--gold) 0%, var(--light-gold) 100%); color: black; font-size: 16px;">üîç SEARCH MEMBER</th></tr>`;
            html += `<tr><th>S.No</th><th>Name</th><th>${currentIndividual.gender?.startsWith('F') ? 'D/O' : 'S/O'}</th></tr>`;
            html += `<tr class="${currentIndividual.gender?.startsWith('F') ? 'female-row' : ''}">`;
            html += `<td>1</td>`;
            html += `<td><strong>${displayName(currentIndividual.name)}</strong></td>`;
            html += `<td>${displayName(currentIndividual.father) || '‚Äî'}</td>`;
            html += `</tr>`;
            html += `</table>`;
            
            // Ancestors Table
            if (showAncestors) {
                const ancestors = getAncestryChain(currentIndividual).slice(1);
                if (ancestors.length > 0) {
                    html += `<table class="lineage-table" style="margin-bottom: 20px;">`;
                    html += `<tr><th colspan="3" style="background: var(--dark-blue); color: var(--gold);">üå≥ ANCESTORS (Father: ${displayName(ancestors[0]?.father) || '‚Äî'})</th></tr>`;
                    html += `<tr><th>S.No</th><th>Name</th><th>Relation</th></tr>`;
                    ancestors.reverse().forEach((a, index) => {
                        const isFemale = a.gender?.startsWith('F');
                        html += `<tr class="${isFemale ? 'female-row' : ''}">`;
                        html += `<td>${index + 1}</td>`;
                        html += `<td><strong>${displayName(a.name)}</strong></td>`;
                        html += `<td>${index === ancestors.length-1 ? 'Earliest' : 'Ancestor'}</td>`;
                        html += `</tr>`;
                    });
                    html += `</table>`;
                }
            }
            
            // Siblings Table
            if (showSiblings && currentIndividual.father) {
                const siblings = db.filter(s => s.father && s.father.toLowerCase() === currentIndividual.father.toLowerCase() && s.name !== currentIndividual.name);
                if (siblings.length > 0) {
                    html += `<table class="lineage-table" style="margin-bottom: 20px;">`;
                    html += `<tr><th colspan="3" style="background: var(--dark-blue); color: var(--gold);">üë• SIBLINGS (Father: ${displayName(currentIndividual.father)})</th></tr>`;
                    html += `<tr><th>S.No</th><th>Name</th><th>Relation</th></tr>`;
                    siblings.forEach((s, index) => {
                        const isFemale = s.gender?.startsWith('F');
                        html += `<tr class="${isFemale ? 'female-row' : ''}" onclick='jumpTo("${s.name.replace(/'/g, "\\'")}", "${s.gen}")' style="cursor: pointer;">`;
                        html += `<td>${index + 1}</td>`;
                        html += `<td><strong>${displayName(s.name)}</strong></td>`;
                        html += `<td>${isFemale ? 'Sister' : 'Brother'}</td>`;
                        html += `</tr>`;
                    });
                    html += `</table>`;
                }
            }
            
            // Descendants Table
            if (showDescendants) {
                const kids = db.filter(c => c.father && c.father.toLowerCase() === currentIndividual.name.toLowerCase());
                if (kids.length > 0) {
                    html += `<table class="lineage-table" style="margin-bottom: 20px;">`;
                    html += `<tr><th colspan="3" style="background: var(--dark-blue); color: var(--gold);">üë∂ DESCENDANTS (Father: ${displayName(currentIndividual.name)})</th></tr>`;
                    html += `<tr><th>S.No</th><th>Name</th><th>Relation</th></tr>`;
                    kids.forEach((k, index) => {
                        const isFemale = k.gender?.startsWith('F');
                        html += `<tr class="${isFemale ? 'female-row' : ''}" onclick='jumpTo("${k.name.replace(/'/g, "\\'")}", "${k.gen}")' style="cursor: pointer;">`;
                        html += `<td>${index + 1}</td>`;
                        html += `<td><strong>${displayName(k.name)}</strong></td>`;
                        html += `<td>${isFemale ? 'Daughter' : 'Son'}</td>`;
                        html += `</tr>`;
                    });
                    html += `</table>`;
                }
            }
            
            html += '</div>';
            document.getElementById('individualTable').innerHTML = html;
        }

        function renderBox(p, label, isSelected, hasChildren) {
            const isFemale = p.gender?.startsWith('F');
            const blinkClass = isSelected ? 'blinking-box' : '';
            
            const memberData = encodeURIComponent(JSON.stringify(p));
            
            return `<div class="box ${isFemale ? 'female-box' : ''} ${blinkClass}" onclick='handleBoxClick(JSON.parse(decodeURIComponent("${memberData}")))'>
                <div class="box-header"><span>${label}</span><span>${p.gen}</span></div>
                <div class="box-body">
                    <span class="member-name">${displayName(p.name)}</span>
                    <span class="father-name">${isFemale ? 'D/o' : 'S/o'}: ${displayName(p.father)}</span>
                    ${hasChildren ? '<div class="golden-heart">‚ù§Ô∏è</div>' : ''}
                </div>
            </div>`;
        }

        // ======================================================================
        // ========================== 8- ROOT RELATIVE FUNCTIONS ===============
        // ======================================================================
        function renderRootTree() {
            if (!rootMember1 || !rootMember2) return;
            
            const chain1 = getAncestryChain(rootMember1);
            const chain2 = getAncestryChain(rootMember2);
            const commonRoot = findCommonRoot(rootMember1, rootMember2);
            
            if (!commonRoot) {
                document.getElementById('rootContent').innerHTML = 
                    '<div class="root-announce"><h3>No common ancestor found</h3></div>';
                return;
            }
            
            const gen1 = getGenNum(rootMember1.gen);
            const gen2 = getGenNum(rootMember2.gen);
            const genRoot = getGenNum(commonRoot.gen);
            const gap1 = Math.abs(gen1 - genRoot);
            const gap2 = Math.abs(gen2 - genRoot);
            const gap12 = Math.abs(gen1 - gen2);
            
            let html = `
                <div>
                <div class="root-announce">
                    <h3 style="text-align: center; margin-bottom: 8px;">Common Root: ${displayName(commonRoot.name)} (${commonRoot.gen})</h3>
                    <div class="generation-info">
                        <div class="gap-row">
                            <div class="gap-item">Member 1 ‚Üí Root <span class="gap-value">${gap1} gen</span></div>
                            <div class="gap-item">Member 2 ‚Üí Root <span class="gap-value">${gap2} gen</span></div>
                            <div class="gap-item">Member 1 ‚Üî Member 2 <span class="gap-value highlight">${gap12} gen</span></div>
                        </div>
                    </div>
                </div>
                <div class="tree-root-layout">
                    <div style="display:flex; gap:30px; flex-wrap:wrap; justify-content:center;">
            `;
            
            const path1 = chain1.slice(0, chain1.findIndex(p => p.name.toLowerCase() === commonRoot.name.toLowerCase()) + 1);
            html += `<div style="text-align: center;"><h4 style="margin-bottom: 10px;">${displayName(rootMember1.name)}'s Path</h4>`;
            path1.forEach((p, i) => {
                const label = i === 0 ? 'Member' : (i === path1.length-1 ? 'Root' : 'Ancestor');
                const hasChildren = db.some(x => x.father && x.father.toLowerCase() === p.name.toLowerCase());
                html += renderBox(p, label, p.name === rootMember1.name, hasChildren);
                if (i < path1.length - 1) html += '<div class="v-line"></div>';
            });
            html += '</div>';
            
            const path2 = chain2.slice(0, chain2.findIndex(p => p.name.toLowerCase() === commonRoot.name.toLowerCase()) + 1);
            html += `<div style="text-align: center;"><h4 style="margin-bottom: 10px;">${displayName(rootMember2.name)}'s Path</h4>`;
            path2.forEach((p, i) => {
                const label = i === 0 ? 'Member' : (i === path2.length-1 ? 'Root' : 'Ancestor');
                const hasChildren = db.some(x => x.father && x.father.toLowerCase() === p.name.toLowerCase());
                html += renderBox(p, label, p.name === rootMember2.name, hasChildren);
                if (i < path2.length - 1) html += '<div class="v-line"></div>';
            });
            html += '</div></div></div></div>';
            
            document.getElementById('rootContent').innerHTML = html;
        }

        function renderRootTable() {
            if (!rootMember1 || !rootMember2) return;
            
            const chain1 = getAncestryChain(rootMember1);
            const chain2 = getAncestryChain(rootMember2);
            const commonRoot = findCommonRoot(rootMember1, rootMember2);
            
            if (!commonRoot) {
                document.getElementById('rootContent').innerHTML = 
                    '<div class="root-announce"><h3>No common ancestor found</h3></div>';
                return;
            }
            
            const gen1 = getGenNum(rootMember1.gen);
            const gen2 = getGenNum(rootMember2.gen);
            const genRoot = getGenNum(commonRoot.gen);
            const gap1 = Math.abs(gen1 - genRoot);
            const gap2 = Math.abs(gen2 - genRoot);
            const gap12 = Math.abs(gen1 - gen2);
            
            let html = `
                <div>
                <div class="root-announce">
                    <h3 style="text-align: center; margin-bottom: 8px;">Common Root: ${displayName(commonRoot.name)} (${commonRoot.gen})</h3>
                    <div class="generation-info">
                        <div class="gap-row">
                            <div class="gap-item">Member 1 ‚Üí Root <span class="gap-value">${gap1} gen</span></div>
                            <div class="gap-item">Member 2 ‚Üí Root <span class="gap-value">${gap2} gen</span></div>
                            <div class="gap-item">Member 1 ‚Üî Member 2 <span class="gap-value highlight">${gap12} gen</span></div>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <div style="display:flex; gap:20px; flex-wrap:wrap; justify-content: center;">
            `;
            
            const path1 = chain1.slice(0, chain1.findIndex(p => p.name.toLowerCase() === commonRoot.name.toLowerCase()) + 1);
            html += `<div style="flex:1; text-align: center;"><h4 style="margin-bottom: 10px;">${displayName(rootMember1.name)}'s Path</h4>
                <table class="lineage-table" style="margin: 0 auto;">
                    <tr><th>#</th><th>Name</th><th>Gen</th></tr>`;
            path1.forEach((p, i) => {
                html += `<tr><td>${i+1}</td><td>${displayName(p.name)}</td><td>${p.gen}</td></tr>`;
            });
            html += '</table></div>';
            
            const path2 = chain2.slice(0, chain2.findIndex(p => p.name.toLowerCase() === commonRoot.name.toLowerCase()) + 1);
            html += `<div style="flex:1; text-align: center;"><h4 style="margin-bottom: 10px;">${displayName(rootMember2.name)}'s Path</h4>
                <table class="lineage-table" style="margin: 0 auto;">
                    <tr><th>#</th><th>Name</th><th>Gen</th></tr>`;
            path2.forEach((p, i) => {
                html += `<tr><td>${i+1}</td><td>${displayName(p.name)}</td><td>${p.gen}</td></tr>`;
            });
            html += '</table></div></div></div></div>';
            
            document.getElementById('rootContent').innerHTML = html;
        }

        // ======================================================================
        // ========================== 9- PDF EXPORT FUNCTIONS ==================
        // ======================================================================
        async function exportIndividualPDF() {
            if (!currentIndividual) {
                alert('Please select a member first');
                return;
            }
            
            const content = individualView === 'tree' 
                ? document.getElementById('individualTree')
                : document.getElementById('individualTable');
            
            if (!content) return alert('No content to export');
            
            const treeElement = content.querySelector('.tree-root-layout') || content;
            
            try {
                const originalHTML = treeElement.innerHTML;
                
                const header = document.createElement('div');
                header.style.marginBottom = '30px';
                header.style.textAlign = 'center';
                header.innerHTML = `
                    <h1 style="color: #d4af37; font-size: 36px; font-family: 'Playfair Display', serif; margin: 0 0 10px 0;">Rizvi Family Tree</h1>
                    <h2 style="color: #5a0000; font-size: 24px; font-family: 'Playfair Display', serif; margin: 0;">${displayName(currentIndividual.name)}</h2>
                `;
                
                const footer = document.createElement('div');
                footer.style.marginTop = '40px';
                footer.style.padding = '15px 20px';
                footer.style.border = '2px solid #d4af37';
                footer.style.borderRadius = '4px';
                footer.style.background = '#0f172a';
                footer.style.color = '#d4af37';
                footer.style.display = 'flex';
                footer.style.justifyContent = 'space-between';
                footer.style.alignItems = 'center';
                footer.style.fontSize = '11px';
                
                const timeStr = formatCurrentTime();
                footer.innerHTML = `
                    <span>${LOAD_STAMP || 'Last data updated on: Unknown'}</span>
                    <span style="font-weight: 500;">PDF generated: ${timeStr}</span>
                `;
                
                const signature = document.createElement('div');
                signature.style.marginTop = '20px';
                signature.style.paddingTop = '15px';
                signature.style.borderTop = '1px solid #ddd';
                signature.style.textAlign = 'center';
                signature.style.color = '#000';
                signature.style.fontSize = '12px';
                signature.style.fontWeight = '500';
                signature.textContent = 'Imran Haider S/o Syed Risalat Hussain Rizvi | 0332-787-6010';
                
                treeElement.insertBefore(header, treeElement.firstChild);
                treeElement.appendChild(footer);
                treeElement.appendChild(signature);
                
                const loadingMsg = document.createElement('div');
                loadingMsg.style.position = 'fixed';
                loadingMsg.style.top = '50%';
                loadingMsg.style.left = '50%';
                loadingMsg.style.transform = 'translate(-50%, -50%)';
                loadingMsg.style.background = '#5a0000';
                loadingMsg.style.color = 'white';
                loadingMsg.style.padding = '20px 40px';
                loadingMsg.style.borderRadius = '8px';
                loadingMsg.style.zIndex = '9999';
                loadingMsg.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
                loadingMsg.textContent = 'üìÑ Preparing PDF... please wait';
                document.body.appendChild(loadingMsg);
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const canvas = await html2canvas(treeElement, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true,
                    useCORS: true
                });
                
                treeElement.removeChild(header);
                treeElement.removeChild(footer);
                treeElement.removeChild(signature);
                document.body.removeChild(loadingMsg);
                
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                const w = canvas.width / 2 * 0.264583;
                const h = canvas.height / 2 * 0.264583;
                
                const pdf = new jsPDF({
                    orientation: w > h ? 'l' : 'p',
                    unit: 'mm',
                    format: [w + 40, h + 40]
                });
                
                pdf.addImage(imgData, 'PNG', 20, 20, w, h);
                
                const safeName = displayName(currentIndividual.name).replace(/[^a-z0-9]/gi, '_').toLowerCase();
                pdf.save(`family_${safeName}_${new Date().getTime()}.pdf`);
                
            } catch (err) {
                console.error('PDF Error:', err);
                alert('‚ùå PDF generation failed: ' + err.message);
            }
        }

        async function exportRootPDF() {
            if (!rootMember1 || !rootMember2) {
                alert('Please select both members first');
                return;
            }
            
            const content = document.getElementById('rootContent');
            if (!content) return alert('No content to export');
            
            const treeElement = content.querySelector('.tree-root-layout') || content;
            
            try {
                const originalHTML = treeElement.innerHTML;
                
                const header = document.createElement('div');
                header.style.marginBottom = '30px';
                header.style.textAlign = 'center';
                header.innerHTML = `
                    <h1 style="color: #d4af37; font-size: 36px; font-family: 'Playfair Display', serif; margin: 0 0 10px 0;">Rizvi Family Tree</h1>
                    <h2 style="color: #5a0000; font-size: 24px; font-family: 'Playfair Display', serif; margin: 0;">${displayName(rootMember1.name)} & ${displayName(rootMember2.name)}</h2>
                `;
                
                const footer = document.createElement('div');
                footer.style.marginTop = '40px';
                footer.style.padding = '15px 20px';
                footer.style.border = '2px solid #d4af37';
                footer.style.borderRadius = '4px';
                footer.style.background = '#0f172a';
                footer.style.color = '#d4af37';
                footer.style.display = 'flex';
                footer.style.justifyContent = 'space-between';
                footer.style.alignItems = 'center';
                footer.style.fontSize = '11px';
                
                const timeStr = formatCurrentTime();
                footer.innerHTML = `
                    <span>${LOAD_STAMP || 'Last data updated on: Unknown'}</span>
                    <span style="font-weight: 500;">PDF generated: ${timeStr}</span>
                `;
                
                const signature = document.createElement('div');
                signature.style.marginTop = '20px';
                signature.style.paddingTop = '15px';
                signature.style.borderTop = '1px solid #ddd';
                signature.style.textAlign = 'center';
                signature.style.color = '#000';
                signature.style.fontSize = '12px';
                signature.style.fontWeight = '500';
                signature.textContent = 'Imran Haider S/o Syed Risalat Hussain Rizvi | 0332-787-6010';
                
                treeElement.insertBefore(header, treeElement.firstChild);
                treeElement.appendChild(footer);
                treeElement.appendChild(signature);
                
                const loadingMsg = document.createElement('div');
                loadingMsg.style.position = 'fixed';
                loadingMsg.style.top = '50%';
                loadingMsg.style.left = '50%';
                loadingMsg.style.transform = 'translate(-50%, -50%)';
                loadingMsg.style.background = '#5a0000';
                loadingMsg.style.color = 'white';
                loadingMsg.style.padding = '20px 40px';
                loadingMsg.style.borderRadius = '8px';
                loadingMsg.style.zIndex = '9999';
                loadingMsg.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
                loadingMsg.textContent = 'üìÑ Preparing PDF... please wait';
                document.body.appendChild(loadingMsg);
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const canvas = await html2canvas(treeElement, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true,
                    useCORS: true
                });
                
                treeElement.removeChild(header);
                treeElement.removeChild(footer);
                treeElement.removeChild(signature);
                document.body.removeChild(loadingMsg);
                
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                const w = canvas.width / 2 * 0.264583;
                const h = canvas.height / 2 * 0.264583;
                
                const pdf = new jsPDF({
                    orientation: w > h ? 'l' : 'p',
                    unit: 'mm',
                    format: [w + 40, h + 40]
                });
                
                pdf.addImage(imgData, 'PNG', 20, 20, w, h);
                
                const safeName1 = displayName(rootMember1.name).replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const safeName2 = displayName(rootMember2.name).replace(/[^a-z0-9]/gi, '_').toLowerCase();
                pdf.save(`root_${safeName1}_${safeName2}_${new Date().getTime()}.pdf`);
                
            } catch (err) {
                console.error('PDF Error:', err);
                alert('‚ùå PDF generation failed: ' + err.message);
            }
        }

        // ======================================================================
        // ========================== 10- AUTO LOAD FUNCTION ====================
        // ======================================================================
        function autoLoadDataFromGitHub() {
            let basePath = '';
            
            if (window.location.hostname.includes('github.io')) {
                const pathParts = window.location.pathname.split('/');
                if (pathParts.length > 1) {
                    basePath = '/' + pathParts[1] + '/';
                }
            }
            
            const possiblePaths = [
                'data.xlsx',
                './data.xlsx',
                '/data.xlsx',
                basePath + 'data.xlsx',
                basePath + 'data/data.xlsx',
                './data/data.xlsx',
                'data/data.xlsx',
                'Rizvi Family Tree.xlsx',
                './Rizvi Family Tree.xlsx',
                '/Rizvi Family Tree.xlsx',
                basePath + 'Rizvi Family Tree.xlsx',
                basePath + 'data/Rizvi Family Tree.xlsx',
                'family-tree.xlsx',
                'FamilyTree.xlsx',
                'tree.xlsx',
                'family.xlsx',
                'data.xls',
                'data.csv',
                'Rizvi Family Tree.xls',
                'Rizvi Family Tree.csv',
                'docs/data.xlsx',
                'docs/Rizvi Family Tree.xlsx',
                'assets/data.xlsx',
                'public/data.xlsx'
            ];
            
            let attempted = 0;
            let found = false;
            let loadingIndicator = document.getElementById('dataStatus');
            
            function showManualOption() {
                loadingIndicator.innerHTML = '‚ö†Ô∏è Click to load manually';
                loadingIndicator.style.color = '#f59e0b';
                loadingIndicator.style.cursor = 'pointer';
                loadingIndicator.onclick = function() {
                    loadDataWithPassword();
                };
                console.log('‚ùå No data file found automatically. Manual loading available.');
            }
            
            function tryNextPath() {
                if (found) return;
                
                if (attempted >= possiblePaths.length) {
                    showManualOption();
                    return;
                }
                
                const path = possiblePaths[attempted];
                attempted++;
                
                loadingIndicator.innerHTML = 'üîç Searching...';
                loadingIndicator.style.color = '#3b82f6';
                
                console.log(`üîç Auto-search ${attempted}/${possiblePaths.length}:`, path);
                
                fetch(path, { 
                    method: 'GET',
                    headers: { 'Cache-Control': 'no-cache' },
                    mode: 'cors'
                })
                    .then(response => {
                        if (!response.ok) throw new Error(`Not found`);
                        return response.arrayBuffer();
                    })
                    .then(data => {
                        try {
                            const wb = XLSX.read(new Uint8Array(data), { type: 'array' });
                            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                            
                            db = rows.map(r => ({
                                name: String(r.Name || r.name || '').trim(),
                                father: String(r.Father || r.father || '').trim(),
                                gen: String(r.Gen || r.gen || '').trim(),
                                gender: String(r.Gender || r.gender || 'M').trim().toUpperCase()
                            })).filter(p => p.name);

                            if (db.length > 0) {
                                currentIndividual = db[0];
                                LOAD_STAMP = getTimestampFromExcel(wb);
                                loadingIndicator.innerHTML = `‚úÖ ${db.length} members loaded`;
                                loadingIndicator.style.color = '#2e7d32';
                                loadingIndicator.style.cursor = 'default';
                                loadingIndicator.onclick = null;
                                console.log(`‚úÖ SUCCESS! Loaded ${db.length} members from:`, path);
                                found = true;
                                
                                setTimeout(() => {
                                    if (!document.getElementById('dashboardSection').classList.contains('hidden')) {
                                        showToast(`‚úÖ Data loaded automatically! ${db.length} family members found.`, 'success');
                                    }
                                }, 500);
                            } else {
                                throw new Error('No valid data in file');
                            }
                        } catch (err) {
                            console.log('‚ö†Ô∏è File found but invalid:', path, err.message);
                            tryNextPath();
                        }
                    })
                    .catch(error => {
                        console.log('‚ùå Not found:', path);
                        tryNextPath();
                    });
            }
            
            loadingIndicator.onclick = null;
            loadingIndicator.style.cursor = 'default';
            
            tryNextPath();
            
            setTimeout(() => {
                if (!found && attempted < possiblePaths.length) {
                    console.log('‚è±Ô∏è Search timeout - showing manual option');
                    showManualOption();
                }
            }, 10000);
        }

        // ======================================================================
        // ========================== 11- PASSWORD FUNCTIONS ===================
        // ======================================================================
        function togglePassword() {
            const pwd = document.getElementById('passwordField');
            const toggle = document.querySelector('.toggle-btn');
            pwd.type = pwd.type === 'password' ? 'text' : 'password';
            toggle.textContent = pwd.type === 'password' ? 'Show' : 'Hide';
        }

        function checkPassword() {
            const pwd = document.getElementById('passwordField').value;
            if (pwd === CONFIG.password) {
                document.getElementById('passwordScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                document.getElementById('mainApp').style.flexDirection = 'column';
                showDashboard();
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordField').value = '';
            }
        }

        document.getElementById('passwordField')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkPassword();
        });

        function logout() {
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('passwordScreen').style.display = 'flex';
            document.getElementById('passwordField').value = '';
            document.getElementById('passwordError').style.display = 'none';
        }

        function loadDataWithPassword() {
            const pwd = prompt('Enter data loading password:');
            if (pwd === CONFIG.dataPassword) {
                document.getElementById('fileInput').click();
            } else if (pwd !== null) {
                alert('‚ùå Invalid password');
            }
        }

        document.getElementById('fileInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    
                    db = rows.map(r => ({
                        name: String(r.Name || r.name || '').trim(),
                        father: String(r.Father || r.father || '').trim(),
                        gen: String(r.Gen || r.gen || '').trim(),
                        gender: String(r.Gender || r.gender || 'M').trim().toUpperCase()
                    })).filter(p => p.name);

                    currentIndividual = db.length > 0 ? db[0] : null;
                    LOAD_STAMP = getTimestampFromExcel(wb);
                    
                    document.getElementById('dataStatus').innerHTML = `‚úÖ ${db.length}`;
                    
                    showToast(`‚úÖ Loaded ${db.length} members`, 'success');
                } catch (err) {
                    showToast('‚ùå Error: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        };

        function showToast(message, type = 'success') {
            const existingToast = document.querySelector('.custom-toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.textContent = message;
            
            if (type === 'success') {
                toast.style.background = '#2e7d32';
            } else {
                toast.style.background = '#5a0000';
            }
            
            toast.style.position = 'fixed';
            toast.style.bottom = '30px';
            toast.style.right = '30px';
            toast.style.color = 'white';
            toast.style.padding = '12px 24px';
            toast.style.borderRadius = '8px';
            toast.style.fontSize = '14px';
            toast.style.fontWeight = '600';
            toast.style.zIndex = '9999';
            toast.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
            toast.style.border = '2px solid #d4af37';
            toast.style.animation = 'slideIn 0.3s ease';
            
            if (!document.querySelector('#toast-keyframes')) {
                const style = document.createElement('style');
                style.id = 'toast-keyframes';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ======================================================================
        // ========================== TOGGLE CANVAS VIEW =======================
        // ======================================================================
        function toggleCanvasView() {
            document.body.classList.toggle('canvas-only');
            const btn = document.getElementById('toggleViewBtn');
            if (document.body.classList.contains('canvas-only')) {
                btn.innerHTML = '<span>üîç</span> <span>Exit</span>';
            } else {
                btn.innerHTML = '<span>üëÅÔ∏è</span> <span>Full Screen</span>';
            }
        }

        // ======================================================================
        // ========================== MOBILE MENU TOGGLE =======================
        // ======================================================================
        document.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.getElementById('mobileMenuToggle');
            const topSection = document.querySelector('.fixed-header-section');
            
            if (menuToggle && topSection) {
                menuToggle.addEventListener('click', function() {
                    topSection.classList.toggle('collapsed');
                });
            }
            
            document.getElementById('filterSiblings').classList.add('active');
            document.getElementById('filterDescendants').classList.add('active');
            document.getElementById('filterAncestors').classList.remove('active');
            autoLoadDataFromGitHub();
        });
    </script>
</body>
</html>