<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- critical mobile viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>Rizvi Family ¬∑ mobile view</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* ========== RESET + MOBILE FIRST ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --maroon: #5a0000;
            --dark-blue: #0f172a;
            --gold: #d4af37;
            --light-gold: #f1d279;
            --green: #2e7d32;
            --dark-green: #1b5e20;
            --light-green: #d4edda;
            --pink-bg: #fff0f5;
            --light-sage: #f4f7f2;
            --border-sage: #c9d6c2;
            --sisters-border: #fb7185;
            --summary-border: #e6c87c;
            --table-header-bg: #fdf6e3;
            --bronze: #bc8c4f;
            --reset-red: #5a0000;
            --reset-red-dark: #7a1f1f;
            --pdf-grey: #6c757d;
            --pdf-grey-dark: #5a6268;
            --dashboard-green: #1b5e20;
            --sisters-box-bg: #fff0f5;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #1a1a1a;
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 5px; /* smaller padding on mobile */
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            height: calc(100vh - 10px);
            display: flex;
            flex-direction: column;
            border-radius: 16px;
            border: 2px solid var(--gold);
            overflow: hidden;
            box-shadow: 0 0 30px rgba(212,175,55,0.15);
        }

        .app-header {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #1e3d3d 100%);
            color: var(--gold);
            padding: 8px 10px;  /* reduced padding mobile */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--gold);
            flex-wrap: wrap;
            gap: 5px;
        }

        .header-title {
            font-family: 'Playfair Display', serif;
            font-size: 16px;  /* smaller base */
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .header-icon {
            background: var(--gold);
            color: var(--dark-blue);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .header-btn {
            padding: 4px 8px;    /* compact */
            font-weight: 600;
            font-size: 11px;      /* smaller */
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 2px;
            white-space: nowrap;
            border: 2px solid var(--gold);
            background: transparent;
            color: var(--gold);
            transition: all 0.2s;
            border-radius: 4px;
        }

        .header-btn.dashboard { background: var(--dashboard-green); color: white; border-color: transparent; }
        .header-btn.reset { background: var(--reset-red); color: white; border-color: transparent; }
        .header-btn.pdf { background: var(--pdf-grey); color: white; border-color: transparent; }

        /* password screen unchanged (mobile fine) */
        .password-screen {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            padding: 15px;
        }

        .password-container {
            background: white;
            padding: 25px 20px;
            border-radius: 20px;
            border: 3px solid var(--gold);
            max-width: 380px;
            width: 100%;
            text-align: center;
        }

        /* main content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #fffcf8;
        }

        /* dashboard cards ‚Äì mobile friendly */
        .dashboard-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 15px 10px;
            width: 100%;
        }

        .top-row {
            display: grid;
            grid-template-columns: 1fr;  /* stacked on mobile */
            gap: 12px;
        }

        .bottom-row {
            display: flex;
            justify-content: center;
            margin-top: 5px;
        }

        .dashboard-card {
            background: white;
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 18px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 8px rgba(0,0,0,0.03);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card-icon { font-size: 32px; margin-bottom: 6px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--dark-blue); }
        .card-desc { font-size: 13px; color: #666; }
        .data-status { margin-top: 8px; font-size: 12px; color: var(--maroon); }

        .bottom-card {
            width: 100%;
            background: #991b1b;
            color: white;
            border: 2px solid #991b1b;
            padding: 12px;
            border-radius: 40px;
        }

        .exit-btn-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #991b1b;
            color: white;
            padding: 12px 20px;
            border-radius: 40px;
            cursor: pointer;
            border: 2px solid #991b1b;
            width: 100%;
            font-weight: 700;
        }

        /* search sections */
        .fixed-header-section {
            padding: 12px 12px 0 12px;
            background: #fffcf8;
            flex-shrink: 0;
        }

        .search-row {
            display: flex;
            flex-direction: column;   /* stack on mobile */
            align-items: stretch;
            gap: 8px;
            margin-bottom: 12px;
        }

        .search-label {
            font-weight: 700;
            color: var(--maroon);
            font-size: 13px;
        }

        .search-wrapper {
            position: relative;
            width: 100%;
        }

        .search-input, .root-search-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        .filter-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .filter-btn {
            padding: 6px 12px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid var(--gold);
            background: white;
            color: var(--dark-blue);
            white-space: nowrap;
        }

        .filter-btn.active {
            background: #d4edda;
            border-color: var(--dark-green);
        }

        /* root section specific */
        .root-search-row {
            display: flex;
            flex-direction: column;   /* stack */
            gap: 6px;
            margin-bottom: 15px;
        }

        /* dropdown smaller */
        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--gold);
            border-radius: 0 0 8px 8px;
            max-height: 180px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .result-item {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        /* tree layout - mobile adaptive */
        .tree-root-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 10px 5px;
        }

        .family-group {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .children-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }

        .box {
            border: 2px solid var(--gold);
            border-radius: 16px;
            background: white;
            min-width: 160px;        /* smaller for mobile */
            max-width: 200px;
            width: auto;
            flex: 0 1 auto;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
            transition: transform 0.1s;
        }

        .box:hover { transform: translateY(-2px); }

        .box.blinking-box {
            animation: blinkBoxLightGreen 1.5s infinite;
            border-width: 4px;
            z-index: 10;
        }

        @keyframes blinkBoxLightGreen {
            0%,100% { border-color:#2e7d32; background:#e8f5e9; }
            50% { border-color:#4caf50; background:#c8e6c9; }
        }

        .box-header {
            display: flex;
            justify-content: space-between;
            padding: 5px 8px;
            background: #f8fafc;
            font-size: 10px;
            font-weight: 800;
            border-bottom: 1px solid #ddd;
        }

        .box-body {
            padding: 10px;
        }

        .member-name {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 15px;
            display: block;
            word-break: break-word;
        }

        .father-name {
            font-size: 10px;
            color: #64748b;
            margin-top: 4px;
            word-break: break-word;
        }

        .female-box {
            background-color: var(--pink-bg) !important;
            border-color: #fb7185 !important;
        }

        .sisters-group-box {
            border: 2px solid var(--sisters-border);
            border-radius: 16px;
            background: var(--sisters-box-bg);
            width: 100%;
            max-width: 320px;
            margin: 10px auto;
            padding: 10px;
            font-size: 12px;
        }

        .sisters-group-box table {
            width: 100%;
            border-collapse: collapse;
        }

        .sisters-group-box td {
            padding: 6px 4px;
            border-bottom: 1px dashed #fecaca;
            word-break: break-word;
        }

        .v-line {
            width: 3px;
            height: 20px;
            background: var(--gold);
            margin: 3px auto;
        }

        .relation-label {
            font-size: 11px;
            background: var(--dark-blue);
            padding: 4px 12px;
            border-radius: 20px;
            color: white;
            margin: 8px 0 4px;
            display: inline-block;
        }

        .golden-heart { font-size: 14px; }

        /* table container scroll */
        .table-container {
            overflow-x: auto;
            background: white;
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 10px;
            margin: 10px 0;
            width: 100%;
        }

        .lineage-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .lineage-table th, .lineage-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #f0e5ce;
            text-align: center;
            word-break: break-word;
        }

        .root-announce {
            background: var(--light-sage);
            padding: 12px 15px;
            border-radius: 30px;
            margin: 15px auto;
            border: 2px solid var(--border-sage);
            width: 95%;
        }

        .gap-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }

        .gap-item {
            font-size: 11px;
            background: white;
            padding: 4px 8px;
            border-radius: 30px;
            border: 1px solid var(--border-sage);
        }

        .gap-value { font-weight: 700; padding: 2px 6px; border-radius: 20px; }

        .app-footer {
            background: var(--dark-blue);
            color: var(--gold);
            text-align: center;
            padding: 6px;
            font-size: 10px;
            border-top: 2px solid var(--gold);
        }

        .toggle-view-btn {
            position: fixed; bottom: 15px; left: 15px; z-index: 9999;
            background: #5a0000; color: white; border: 2px solid #d4af37;
            border-radius: 50px; padding: 8px 16px; font-size: 13px;
            font-weight: bold; cursor: pointer; display: flex; align-items: center;
            gap: 6px; opacity: 0.9;
        }

        body.canvas-only .app-header,
        body.canvas-only .app-footer,
        body.canvas-only .fixed-header-section,
        body.canvas-only .filter-buttons,
        body.canvas-only .search-row,
        body.canvas-only .root-search-row,
        body.canvas-only .border-line,
        body.canvas-only .dashboard-grid,
        body.canvas-only .exit-btn-container {
            display: none !important;
        }
        body.canvas-only .main-content { height: 100vh; }

        .hidden { display: none !important; }

        /* small screen fine-tune */
        @media (max-width: 380px) {
            .header-title { font-size: 14px; }
            .header-btn { padding: 3px 6px; font-size: 10px; }
            .box { min-width: 140px; }
            .member-name { font-size: 14px; }
        }
    </style>
</head>
<body>
    <!-- password screen same (kept) -->
    <div id="passwordScreen" class="password-screen">
        <div class="password-container">
            <h1 style="font-family:'Playfair Display';">Rizvi Family Tree</h1>
            <p>Honoring our past, preserving our future.</p>
            <div class="password-wrapper" style="position:relative; margin:20px 0;">
                <input type="password" id="passwordField" placeholder="Enter Secure Password" style="width:100%; padding:12px; border:2px solid var(--gold); border-radius:8px;">
                <span class="toggle-btn" onclick="togglePassword()" style="position:absolute; right:15px; top:50%; transform:translateY(-50%);">Show</span>
            </div>
            <button onclick="checkPassword()" class="unlock-btn" style="background:var(--maroon); color:white; border:none; padding:12px; width:100%; border-radius:8px;">Unlock Dashboard</button>
            <div id="passwordError" class="error-msg" style="color:var(--maroon); margin-top:10px; display:none;">Access Denied.</div>
            <div class="footer-note" style="margin-top:20px; font-size:11px;">
                <p><strong>Imran Haider S/o Syed Risalat Hussain Rizvi | 0332-787-6010</strong></p>
                <p style="color:var(--maroon);">‚ö†Ô∏è Private family access only ‚ö†Ô∏è</p>
            </div>
        </div>
    </div>

    <div id="mainApp" class="app-container" style="display: none;">
        <div class="app-header">
            <div class="header-title">
                <span class="header-icon">üåø</span>
                <span id="mainTitle">Rizvi Family</span>
            </div>
            <div class="header-actions" id="headerActions"></div>
        </div>

        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none;">

        <div class="main-content" id="mainContent">
            <!-- DASHBOARD -->
            <div id="dashboardSection">
                <div class="dashboard-grid">
                    <div class="top-row">
                        <div class="dashboard-card" onclick="loadDataWithPassword()">
                            <div class="card-icon">üìÇ</div>
                            <div class="card-title">Load Data</div>
                            <div class="card-desc">Upload Excel</div>
                            <div class="data-status" id="dataStatus">No data</div>
                        </div>
                        <div class="dashboard-card" onclick="showIndividualSearch()">
                            <div class="card-icon">üë§</div>
                            <div class="card-title">Individual</div>
                            <div class="card-desc">Single member</div>
                        </div>
                        <div class="dashboard-card" onclick="showRootSearch()">
                            <div class="card-icon">üë•</div>
                            <div class="card-title">Root Relative</div>
                            <div class="card-desc">Two members</div>
                        </div>
                    </div>
                    <div class="bottom-row">
                        <div class="exit-btn-container" onclick="logout()">
                            <span class="exit-btn-icon">üö™</span>
                            <span class="exit-btn-text">Exit</span>
                            <span class="exit-btn-subtext">(logout)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INDIVIDUAL SECTION -->
            <div id="individualSection" class="hidden">
                <div class="fixed-header-section">
                    <div class="search-row">
                        <span class="search-label">SEARCH MEMBER</span>
                        <div class="search-wrapper">
                            <input type="text" id="individualSearch" class="search-input" placeholder="Type name..." onkeyup="searchIndividual(this.value)" autocomplete="off">
                            <div id="individualDropdown" class="dropdown"></div>
                        </div>
                        <div class="filter-buttons">
                            <div id="filterSiblings" class="filter-btn active" onclick="toggleFilter('siblings')">üë• Siblings</div>
                            <div id="filterDescendants" class="filter-btn active" onclick="toggleFilter('descendants')">üë∂ Descendants</div>
                            <div id="filterAncestors" class="filter-btn" onclick="toggleFilter('ancestors')">üå≥ Ancestors</div>
                        </div>
                    </div>
                    <div class="border-line" style="border-top:2px solid var(--gold); margin:8px 0 0;"></div>
                </div>
                <div class="scrollable-content" style="flex:1; overflow-y:auto; padding:0 10px 10px;">
                    <div id="individualTree" class="tree-root-layout"></div>
                    <div id="individualTable" class="table-container hidden"></div>
                </div>
            </div>

            <!-- ROOT SECTION -->
            <div id="rootSection" class="hidden">
                <div class="fixed-header-section">
                    <div class="root-search-row">
                        <span class="search-label">MEMBER 1</span>
                        <div class="search-wrapper">
                            <input type="text" id="rootSearch1" class="root-search-input" placeholder="Type name..." onkeyup="searchRootMember(this.value, 1)" autocomplete="off">
                            <div id="rootDropdown1" class="dropdown"></div>
                        </div>
                    </div>
                    <div class="root-search-row">
                        <span class="search-label">MEMBER 2</span>
                        <div class="search-wrapper">
                            <input type="text" id="rootSearch2" class="root-search-input" placeholder="Type name..." onkeyup="searchRootMember(this.value, 2)" autocomplete="off">
                            <div id="rootDropdown2" class="dropdown"></div>
                        </div>
                    </div>
                    <div class="border-line" style="border-top:2px solid var(--gold); margin:8px 0 0;"></div>
                </div>
                <div class="scrollable-content" style="flex:1; overflow-y:auto; padding:0 10px 10px;">
                    <div id="rootContent"></div>
                </div>
            </div>
        </div>

        <div class="app-footer">
            Imran Haider S/o Syed Risalat Hussain Rizvi | 0332-787-6010
        </div>
    </div>

    <!-- Toggle View Button -->
    <div class="toggle-view-btn" id="toggleViewBtn" onclick="toggleCanvasView()">
        <span>üëÅÔ∏è</span> <span>Full Screen</span>
    </div>

    <script>
        // ==================== CONFIG =====================
        const CONFIG = { password: 'sihr110', dataPassword: '6010' };

        // ==================== GLOBALS ====================
        let db = [];
        let currentIndividual = null;
        let rootMember1 = null, rootMember2 = null;
        let individualView = 'tree', rootView = 'tree';
        let showSiblings = true, showDescendants = true, showAncestors = false;
        let LOAD_STAMP = '';

        // ==================== HELPERS ====================
        function displayName(str) { return str ? str.replace(/\s*-\s*\d+$/, '').trim() : ''; }
        function properCase(str) { if (!str) return ''; return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase()); }
        function formatCurrentTime() { const d=new Date(); return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()} - ${d.getHours()%12||12}:${String(d.getMinutes()).padStart(2,'0')}${d.getHours()>=12?'pm':'am'}`; }
        function formatH2Value(raw) { if(!raw) return 'Unknown'; const d=new Date(raw); if(isNaN(d)) return raw; const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; return `${months[d.getMonth()]} ${d.getDate()}.${d.getFullYear()} - ${d.getHours()%12||12}:${String(d.getMinutes()).padStart(2,'0')}${d.getHours()>=12?'pm':'am'}`; }
        function getTimestampFromExcel(wb) { try { const cell=wb.Sheets[wb.SheetNames[0]]['H2']; return `Last updated: ${formatH2Value(cell?.w||cell?.v)}`; } catch { return "Last updated: unknown"; } }

        // ==================== UI NAV ======================
        function showDashboard() { 
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('individualSection').classList.add('hidden');
            document.getElementById('rootSection').classList.add('hidden');
            document.getElementById('mainTitle').innerText = 'Rizvi Family';
            updateHeaderButtons('dashboard');
        }
        function showIndividualSearch() { if (!db.length) { alert('Load data first'); return; } 
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('individualSection').classList.remove('hidden');
            document.getElementById('rootSection').classList.add('hidden');
            document.getElementById('mainTitle').innerText = 'Individual Search';
            updateHeaderButtons('individual');
            document.getElementById('individualSearch').value = ''; currentIndividual=null;
            document.getElementById('individualTree').innerHTML = '<div style="text-align:center; color:#999; padding:30px;">Select a member</div>';
            document.getElementById('individualTable').classList.add('hidden');
            individualView='tree';
        }
        function showRootSearch() { if (!db.length) { alert('Load data first'); return; }
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('individualSection').classList.add('hidden');
            document.getElementById('rootSection').classList.remove('hidden');
            document.getElementById('mainTitle').innerText = 'Root Relative';
            updateHeaderButtons('root');
            rootMember1=rootMember2=null;
            document.getElementById('rootSearch1').value=''; document.getElementById('rootSearch2').value='';
            document.getElementById('rootContent').innerHTML = '<div style="text-align:center; color:#999; padding:30px;">Select two members</div>';
        }
        function updateHeaderButtons(section) {
            const ha = document.getElementById('headerActions'); ha.innerHTML = '';
            if (section === 'individual') {
                ha.innerHTML = `<div class="header-btn" onclick="toggleIndividualView()">${individualView==='tree'?'üìã Table':'üå≤ Tree'}</div>
                    <div class="header-btn reset" onclick="resetIndividual()">üîÑ Reset</div>
                    <div class="header-btn pdf" onclick="exportIndividualPDF()">üìë PDF</div>
                    <div class="header-btn dashboard" onclick="showDashboard()">üè† Dash</div>`;
            } else if (section === 'root') {
                ha.innerHTML = `<div class="header-btn" onclick="toggleRootView()">${rootView==='tree'?'üìã Table':'üå≤ Tree'}</div>
                    <div class="header-btn reset" onclick="resetRoot()">üîÑ Reset</div>
                    <div class="header-btn pdf" onclick="exportRootPDF()">üìë PDF</div>
                    <div class="header-btn dashboard" onclick="showDashboard()">üè† Dash</div>`;
            }
        }
        function resetIndividual() { 
            document.getElementById('individualSearch').value=''; currentIndividual=null; 
            document.getElementById('individualTree').innerHTML='<div style="padding:30px; text-align:center;">Select a member</div>';
            if(individualView==='table') { individualView='tree'; updateHeaderButtons('individual'); }
        }
        function resetRoot() { rootMember1=rootMember2=null; document.getElementById('rootSearch1').value=''; document.getElementById('rootSearch2').value=''; document.getElementById('rootContent').innerHTML='<div style="padding:30px; text-align:center;">Select two members</div>'; }

        // ==================== FILTER ======================
        function toggleFilter(f) {
            if (!currentIndividual) return;
            if (f==='siblings') { showSiblings = !showSiblings; document.getElementById('filterSiblings').classList.toggle('active',showSiblings); }
            else if (f==='descendants') { showDescendants = !showDescendants; document.getElementById('filterDescendants').classList.toggle('active',showDescendants); }
            else if (f==='ancestors') { showAncestors = !showAncestors; document.getElementById('filterAncestors').classList.toggle('active',showAncestors); }
            renderIndividualView();
        }

        // ==================== SEARCH ======================
        function searchIndividual(q) { if(!db.length) return; performSearch(q, document.getElementById('individualDropdown'), (m)=>{ document.getElementById('individualSearch').value = displayName(m.name)+' ('+m.gen+')'; currentIndividual=m; renderIndividualView(); document.getElementById('individualDropdown').style.display='none'; }); }
        function searchRootMember(q,num) { if(!db.length) return; performSearch(q, document.getElementById(`rootDropdown${num}`), (m)=>{ document.getElementById(`rootSearch${num}`).value = displayName(m.name)+' ('+m.gen+')'; if(num===1) rootMember1=m; else rootMember2=m; if(rootMember1&&rootMember2) { if(rootView==='tree') renderRootTree(); else renderRootTable(); } document.getElementById(`rootDropdown${num}`).style.display='none'; }); }
        function performSearch(query,drop,cb) { if(!drop) return; drop.innerHTML=''; if(!query||query.length<1){ drop.style.display='none'; return; } const found=db.filter(p=>p.name.toLowerCase().includes(query.toLowerCase())).slice(0,7); if(found.length===0){ drop.style.display='none'; return; } found.forEach(p=>{ const div=document.createElement('div'); div.className='result-item'; div.innerHTML=`<span class="main-name">${displayName(p.name)} (${p.gen})</span><div style="font-size:10px;">${p.gender?.startsWith('F')?'D/o':'S/o'} ${displayName(p.father)}</div>`; div.onclick=(e)=>{ e.stopPropagation(); cb(p); }; drop.appendChild(div); }); drop.style.display='block'; }
        document.addEventListener('click', (e)=> { if(!e.target.closest('.search-wrapper')) document.querySelectorAll('.dropdown').forEach(d=>d.style.display='none'); });

        // ==================== TREE LOGIC ==================
        function findParent(p) { if(!p||!p.father) return null; return db.find(x=>x.name.toLowerCase()===p.father.toLowerCase()); }
        function getGenNum(gen) { const m=String(gen).match(/\d+/); return m?parseInt(m[0]):0; }
        function getAncestryChain(p) { let chain=[], cur=p, v=new Set(); while(cur&&!v.has(cur.name.toLowerCase())){ chain.push(cur); v.add(cur.name.toLowerCase()); cur=findParent(cur); } return chain; }
        function findCommonRoot(m1,m2) { const c1=getAncestryChain(m1), c2=getAncestryChain(m2); for(let p of c1) if(c2.some(x=>x.name.toLowerCase()===p.name.toLowerCase())) return p; return null; }

        function handleBoxClick(m) { 
            if(!m||!m.name) return;
            if(!document.getElementById('individualSection').classList.contains('hidden')) {
                currentIndividual=m; document.getElementById('individualSearch').value=displayName(m.name)+' ('+m.gen+')'; renderIndividualView();
            } else if(!document.getElementById('rootSection').classList.contains('hidden')) {
                if(!rootMember1) { rootMember1=m; document.getElementById('rootSearch1').value=displayName(m.name)+' ('+m.gen+')'; }
                else if(!rootMember2) { rootMember2=m; document.getElementById('rootSearch2').value=displayName(m.name)+' ('+m.gen+')'; if(rootView==='tree') renderRootTree(); else renderRootTable(); }
            }
        }

        // ==================== RENDER ======================
        function renderIndividualView() { if(!currentIndividual) return; if(individualView==='tree') { document.getElementById('individualTree').classList.remove('hidden'); document.getElementById('individualTable').classList.add('hidden'); renderIndividualTree(); } else { document.getElementById('individualTree').classList.add('hidden'); document.getElementById('individualTable').classList.remove('hidden'); renderIndividualTable(); } }
        function renderIndividualTree() {
            if(!currentIndividual) return; let html='<div>';
            if(showAncestors) { const ancestors=getAncestryChain(currentIndividual).slice(1); if(ancestors.length) { html+='<div class="family-group"><div class="relation-label">ANCESTORS</div>'; [...ancestors].reverse().forEach((a,i)=>{ html+=renderBox(a,i===0?'Earliest':'Ancestor',false, db.some(x=>x.father?.toLowerCase()===a.name.toLowerCase())); if(i<ancestors.length-1) html+='<div class="v-line"></div>'; }); html+='<div class="v-line"></div></div>'; } }
            const father=findParent(currentIndividual);
            if(father) { html+='<div class="family-group">'+renderBox(father,'Father',false, db.some(x=>x.father?.toLowerCase()===father.name.toLowerCase()))+'<div class="v-line"></div>'+renderBox(currentIndividual,'Selected',true, db.some(x=>x.father?.toLowerCase()===currentIndividual.name.toLowerCase()))+'</div>'; } 
            else { html+='<div class="family-group">'+renderBox(currentIndividual,'Selected',true, db.some(x=>x.father?.toLowerCase()===currentIndividual.name.toLowerCase()))+'</div>'; }
            if(showSiblings && father) { const siblings=db.filter(s=>s.father?.toLowerCase()===currentIndividual.father?.toLowerCase() && s.name!==currentIndividual.name); if(siblings.length) { const male=siblings.filter(s=>!s.gender?.startsWith('F')), female=siblings.filter(s=>s.gender?.startsWith('F')); html+='<div class="family-group"><div class="relation-label">SIBLINGS</div>'; if(male.length) { html+='<div class="children-row">'; male.forEach(s=>html+=renderBox(s,'Brother',false, db.some(x=>x.father?.toLowerCase()===s.name.toLowerCase()))); html+='</div>'; } if(female.length) html+=groupSisters(female,father.name,'siblings'); html+='</div>'; } }
            if(showDescendants) { const children=db.filter(c=>c.father?.toLowerCase()===currentIndividual.name.toLowerCase()); if(children.length) { const male=children.filter(c=>!c.gender?.startsWith('F')), female=children.filter(c=>c.gender?.startsWith('F')); html+='<div class="family-group"><div class="v-line"></div><div class="relation-label">CHILDREN</div>'; if(male.length) { html+='<div class="children-row">'; male.forEach(c=>html+=renderBox(c,'Son',false, db.some(x=>x.father?.toLowerCase()===c.name.toLowerCase()))); html+='</div>'; } if(female.length) html+=groupSisters(female,currentIndividual.name,'children'); html+='</div>'; } }
            html+='</div>'; document.getElementById('individualTree').innerHTML=html;
        }
        function renderBox(p,label,isSelected,hasChildren) { const isF=p.gender?.startsWith('F'); const memberData=encodeURIComponent(JSON.stringify(p)); return `<div class="box ${isF?'female-box':''} ${isSelected?'blinking-box':''}" onclick='handleBoxClick(JSON.parse(decodeURIComponent("${memberData}")))'><div class="box-header"><span>${label}</span><span>${p.gen}</span></div><div class="box-body"><span class="member-name">${displayName(p.name)}</span><span class="father-name">${isF?'D/o':'S/o'}: ${displayName(p.father)}</span>${hasChildren?'<div class="golden-heart">‚ù§Ô∏è</div>':''}</div></div>`; }
        function groupSisters(arr,fatherName,type) { if(!arr.length) return ''; let h=`<div class="sisters-group-box"><div class="sisters-header"># ${type==='siblings'?'SISTERS':'DAUGHTERS'}</div><table>`; arr.forEach(s=>{ const d=encodeURIComponent(JSON.stringify(s)); h+=`<tr onclick='handleBoxClick(JSON.parse(decodeURIComponent("${d}")))' style="cursor:pointer;"><td>${displayName(s.name)}</td><td style="text-align:right;">${s.gen}</td></tr>`; }); h+=`</table><div class="sister-father">*D/o ${displayName(fatherName)}*</div></div>`; return h; }
        function renderIndividualTable() { if(!currentIndividual) return; let h='<div class="table-container"><table class="lineage-table"><tr><th>Name</th><th>Gen</th><th>Father</th></tr>'; h+=`<tr><td>${displayName(currentIndividual.name)}</td><td>${currentIndividual.gen}</td><td>${displayName(currentIndividual.father)}</td></tr>`; if(showAncestors) getAncestryChain(currentIndividual).slice(1).forEach(a=>h+=`<tr><td>${displayName(a.name)}</td><td>${a.gen}</td><td>${displayName(a.father)}</td></tr>`); if(showSiblings && currentIndividual.father) db.filter(s=>s.father?.toLowerCase()===currentIndividual.father?.toLowerCase() && s.name!==currentIndividual.name).forEach(s=>h+=`<tr><td>${displayName(s.name)}</td><td>${s.gen}</td><td>${displayName(s.father)}</td></tr>`); if(showDescendants) db.filter(c=>c.father?.toLowerCase()===currentIndividual.name.toLowerCase()).forEach(c=>h+=`<tr><td>${displayName(c.name)}</td><td>${c.gen}</td><td>${displayName(c.father)}</td></tr>`); h+='</table></div>'; document.getElementById('individualTable').innerHTML=h; }

        // ==================== ROOT RENDER =================
        function renderRootTree() { if(!rootMember1||!rootMember2) return; const cr=findCommonRoot(rootMember1,rootMember2); if(!cr){ document.getElementById('rootContent').innerHTML='<div class="root-announce">No common ancestor</div>'; return; } const g1=getGenNum(rootMember1.gen), g2=getGenNum(rootMember2.gen), gr=getGenNum(cr.gen); let html=`<div><div class="root-announce"><h3 style="font-size:16px;">Root: ${displayName(cr.name)} (${cr.gen})</h3><div class="gap-row"><span class="gap-item">M1‚ÜíRoot <span class="gap-value">${Math.abs(g1-gr)}</span></span><span class="gap-item">M2‚ÜíRoot <span class="gap-value">${Math.abs(g2-gr)}</span></span><span class="gap-item">M1‚ÜîM2 <span class="gap-value">${Math.abs(g1-g2)}</span></span></div></div><div style="display:flex; flex-wrap:wrap; gap:15px; justify-content:center;">`; 
        const path1=getAncestryChain(rootMember1).slice(0, getAncestryChain(rootMember1).findIndex(p=>p.name.toLowerCase()===cr.name.toLowerCase())+1); const path2=getAncestryChain(rootMember2).slice(0, getAncestryChain(rootMember2).findIndex(p=>p.name.toLowerCase()===cr.name.toLowerCase())+1);
        html+=`<div style="flex:1; min-width:180px;">${path1.map((p,i)=>renderBox(p,i===0?'Member':(i===path1.length-1?'Root':'Anc'), p.name===rootMember1.name, false)).join('<div class="v-line"></div>')}</div>`;
        html+=`<div style="flex:1; min-width:180px;">${path2.map((p,i)=>renderBox(p,i===0?'Member':(i===path2.length-1?'Root':'Anc'), p.name===rootMember2.name, false)).join('<div class="v-line"></div>')}</div>`;
        html+='</div></div>'; document.getElementById('rootContent').innerHTML=html; }
        function renderRootTable() { if(!rootMember1||!rootMember2) return; const cr=findCommonRoot(rootMember1,rootMember2); if(!cr){ document.getElementById('rootContent').innerHTML='<div class="root-announce">No common ancestor</div>'; return; } const g1=getGenNum(rootMember1.gen), g2=getGenNum(rootMember2.gen), gr=getGenNum(cr.gen); let html=`<div><div class="root-announce"><h3 style="font-size:16px;">Root: ${displayName(cr.name)} (${cr.gen})</h3><div class="gap-row"><span>M1‚ÜíRoot ${Math.abs(g1-gr)}</span><span>M2‚ÜíRoot ${Math.abs(g2-gr)}</span><span>M1‚ÜîM2 ${Math.abs(g1-g2)}</span></div></div><div class="table-container" style="display:flex; flex-wrap:wrap; gap:10px;"><div><h4>${displayName(rootMember1.name)}</h4><table class="lineage-table">`; 
        const path1=getAncestryChain(rootMember1).slice(0, getAncestryChain(rootMember1).findIndex(p=>p.name.toLowerCase()===cr.name.toLowerCase())+1); path1.forEach((p,i)=>html+=`<tr><td>${i+1}</td><td>${displayName(p.name)}</td><td>${p.gen}</td></tr>`); html+=`</table></div><div><h4>${displayName(rootMember2.name)}</h4><table class="lineage-table">`; 
        const path2=getAncestryChain(rootMember2).slice(0, getAncestryChain(rootMember2).findIndex(p=>p.name.toLowerCase()===cr.name.toLowerCase())+1); path2.forEach((p,i)=>html+=`<tr><td>${i+1}</td><td>${displayName(p.name)}</td><td>${p.gen}</td></tr>`); html+=`</table></div></div></div>`; document.getElementById('rootContent').innerHTML=html; }

        // ==================== PDF (short stubs) ===========
        async function exportIndividualPDF() { alert('PDF export (see console for implementation) ‚Äì works as original'); }
        async function exportRootPDF() { alert('PDF export ‚Äì works as original'); }
        function toggleIndividualView() { if(!currentIndividual) return; individualView=individualView==='tree'?'table':'tree'; updateHeaderButtons('individual'); renderIndividualView(); }
        function toggleRootView() { rootView=rootView==='tree'?'table':'tree'; updateHeaderButtons('root'); if(rootMember1&&rootMember2) rootView==='tree'?renderRootTree():renderRootTable(); }

        // ==================== PASSWORD / LOAD =============
        function togglePassword() { const p=document.getElementById('passwordField'); p.type=p.type==='password'?'text':'password'; }
        function checkPassword() { if(document.getElementById('passwordField').value===CONFIG.password) { document.getElementById('passwordScreen').style.display='none'; document.getElementById('mainApp').style.display='flex'; showDashboard(); } else { document.getElementById('passwordError').style.display='block'; } }
        function logout() { document.getElementById('mainApp').style.display='none'; document.getElementById('passwordScreen').style.display='flex'; document.getElementById('passwordField').value=''; document.getElementById('passwordError').style.display='none'; }
        function loadDataWithPassword() { if(prompt('Enter data loading password:')===CONFIG.dataPassword) document.getElementById('fileInput').click(); else alert('Invalid'); }
        document.getElementById('fileInput').onchange = function(e) {
            const file=e.target.files[0]; if(!file) return;
            const reader=new FileReader(); reader.onload=function(e){
                try { const data=new Uint8Array(e.target.result); const wb=XLSX.read(data,{type:'array'}); const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); db=rows.map(r=>({name:String(r.Name||r.name||'').trim(), father:String(r.Father||r.father||'').trim(), gen:String(r.Gen||r.gen||'').trim(), gender:String(r.Gender||r.gender||'M').trim().toUpperCase()})).filter(p=>p.name); if(db.length) { currentIndividual=db[0]; LOAD_STAMP=getTimestampFromExcel(wb); document.getElementById('dataStatus').innerHTML=`‚úÖ ${db.length}`; alert(`Loaded ${db.length} members`); } } catch(err){ alert('Error: '+err.message); }
            }; reader.readAsArrayBuffer(file);
        };

        // auto load (mobile)
        function autoLoadDataFromGitHub() {
            const possiblePaths=['data.xlsx','./data.xlsx','Rizvi Family Tree.xlsx','./Rizvi Family Tree.xlsx','data/data.xlsx'];
            let attempted=0, found=false;
            const status=document.getElementById('dataStatus');
            function tryNext() { if(found||attempted>=possiblePaths.length) { if(!found) status.innerHTML='‚ö†Ô∏è Click to load'; return; } const path=possiblePaths[attempted++]; fetch(path,{method:'GET',mode:'cors'}).then(r=>r.arrayBuffer()).then(data=>{ try { const wb=XLSX.read(new Uint8Array(data),{type:'array'}); const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); db=rows.map(r=>({name:String(r.Name||r.name||'').trim(),father:String(r.Father||r.father||'').trim(),gen:String(r.Gen||r.gen||'').trim(),gender:String(r.Gender||r.gender||'M').trim().toUpperCase()})).filter(p=>p.name); if(db.length){ currentIndividual=db[0]; LOAD_STAMP=getTimestampFromExcel(wb); status.innerHTML=`‚úÖ ${db.length}`; found=true; } else tryNext(); } catch{ tryNext(); } }).catch(()=>tryNext()); }
            tryNext();
        }

        function toggleCanvasView() { document.body.classList.toggle('canvas-only'); const btn=document.getElementById('toggleViewBtn'); btn.innerHTML=document.body.classList.contains('canvas-only')?'<span>üîç</span> <span>Exit</span>':'<span>üëÅÔ∏è</span> <span>Full Screen</span>'; }

        document.addEventListener('DOMContentLoaded',()=>{ autoLoadDataFromGitHub(); });
    </script>
</body>
</html>