<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rizvi Family Tree - Official Viewer</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { 
            --maroon: #5a0000; 
            --dark-blue: #0f172a; 
            --member-blue: #b45309; 
            --blink-red: #ef4444; 
            --light-yellow: #fefce8; 
            --direct-green: #dcfce7;
            --pink-bg: #fffaf0; 
            --pink-border: #d4af37; 
            --gold: #b8860b;
        }

        body { font-family: 'Inter', sans-serif; background: #f8fafc; margin: 0; overflow: hidden; }

        .header { 
            background: white; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-bottom: 3px solid var(--maroon); position: relative; z-index: 1000;
        }
        .logo-area h1 { font-family: 'Playfair Display', serif; color: var(--maroon); margin: 0; font-size: 24px; }
        
        .nav-controls { display: flex; gap: 10px; align-items: center; }
        
        .btn { 
            padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; 
            transition: all 0.2s; font-size: 13px; display: flex; align-items: center; gap: 6px;
        }
        .btn-pdf { background: var(--maroon); color: white; }
        .btn-pdf:hover { background: #800000; }

        .search-box { position: relative; }
        .search-box input { 
            padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; width: 250px; outline: none;
        }

        #viewer-container { width: 100vw; height: calc(100vh - 70px); overflow: auto; background: #f1f5f9; cursor: grab; }
        #viewer-container:active { cursor: grabbing; }
        #tree-surface { position: relative; padding: 100px; min-width: 5000px; min-height: 5000px; transform-origin: 0 0; }

        .member-card {
            position: absolute; width: 220px; background: white; border: 2px solid #cbd5e1;
            border-radius: 10px; padding: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            transition: all 0.3s; z-index: 10; cursor: pointer;
        }
        .member-card:hover { transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--maroon); }
        .member-card.highlight { border-color: var(--blink-red); border-width: 3px; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .gender-tag { font-size: 10px; font-weight: bold; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; margin-bottom: 6px; display: inline-block; }
        .male { background: #dbeafe; color: #1e40af; }
        .female { background: #fce7f3; color: #9d174d; }

        .name { font-weight: 700; color: var(--dark-blue); font-size: 14px; margin-bottom: 4px; }
        .gen-id { font-size: 11px; color: #64748b; font-family: monospace; }

        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        line { stroke: #94a3b8; stroke-width: 2; }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo-area">
            <h1>Rizvi Family Tree</h1>
        </div>
        
        <div class="nav-controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search name..." oninput="handleSearch()">
            </div>
            <button class="btn btn-pdf" onclick="exportPDF()">Download PDF</button>
        </div>
    </header>

    <div id="viewer-container">
        <div id="tree-surface">
            <svg id="svg-layer"></svg>
            <div id="members-layer"></div>
        </div>
    </div>

<script>
    let db = [];
    const HORIZONTAL_GAP = 300;
    const VERTICAL_GAP = 100;

    // AUTO-LOAD FROM data.json
    window.addEventListener('DOMContentLoaded', () => {
        fetch('data.json')
            .then(response => {
                if (!response.ok) throw new Error("File not found");
                return response.json();
            })
            .then(data => {
                db = data;
                renderTree();
            })
            .catch(err => {
                console.error("Loading Error:", err);
                alert("Please ensure data.json is uploaded to the same folder on GitHub.");
            });
    });

    function renderTree() {
        const layer = document.getElementById('members-layer');
        const svg = document.getElementById('svg-layer');
        layer.innerHTML = "";
        svg.innerHTML = "";

        if (db.length === 0) return;

        // Simple Layout Logic
        let generations = {};
        db.forEach(m => {
            let genNum = m.Gen.split('-')[1] || "0";
            if (!generations[genNum]) generations[genNum] = [];
            generations[genNum].push(m);
        });

        let sortedGens = Object.keys(generations).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
        let positions = new Map();

        sortedGens.forEach((gen, xIdx) => {
            generations[gen].forEach((m, yIdx) => {
                const x = xIdx * HORIZONTAL_GAP + 50;
                const y = yIdx * VERTICAL_GAP + 50;
                positions.set(m.Name, { x, y });

                const card = document.createElement('div');
                card.className = 'member-card';
                card.style.left = `${x}px`;
                card.style.top = `${y}px`;
                card.innerHTML = `
                    <span class="gender-tag ${m.Gender.toLowerCase()}">${m.Gender}</span>
                    <div class="name">${m.Name}</div>
                    <div class="gen-id">${m.Gen}</div>
                `;
                layer.appendChild(card);
            });
        });

        // Draw connecting lines
        db.forEach(m => {
            if (m.Father && positions.has(m.Father) && positions.has(m.Name)) {
                const start = positions.get(m.Father);
                const end = positions.get(m.Name);
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", start.x + 220);
                line.setAttribute("y1", start.y + 35);
                line.setAttribute("x2", end.x);
                line.setAttribute("y2", end.y + 35);
                svg.appendChild(line);
            }
        });
    }

    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.member-card').forEach(card => {
            if (term && card.innerText.toLowerCase().includes(term)) {
                card.classList.add('highlight');
            } else {
                card.classList.remove('highlight');
            }
        });
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        html2canvas(document.getElementById('tree-surface')).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('l', 'mm', [canvas.width * 0.2, canvas.height * 0.2]);
            pdf.addImage(imgData, 'PNG', 10, 10);
            pdf.save("Rizvi_Family_Tree.pdf");
        });
    }
</script>

</body>
</html>
