<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Rizvi Family Tree ¬∑ Complete Viewer</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --maroon: #5a0000;
            --dark-blue: #0f172a;
            --gold: #d4af37;
            --light-gold: #f1d279;
            --green: #2e7d32;
            --dark-green: #1b5e20;
            --light-green: #d4edda;
            --pink-bg: #fff0f5;
            --sage: #5f6f52;
            --light-sage: #f4f7f2;
            --border-sage: #c9d6c2;
            --bronze: #bc8c4f;
            --text-dark: #2c3e2f;
            --reset-red: #dc2626;
            --reset-red-dark: #b91c1c;
            --pdf-green: #059669;
            --pdf-green-dark: #047857;
            --exit-red: #991b1b;
            --summary-bg: #fffbf0;
            --summary-border: #e6c87c;
            --summary-text: #3a2c0f;
            --table-header-bg: #fdf6e3;
            --table-header-text: #5e4a1a;
            --accent-light: #faebcd;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #1a1a1a;
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 10px;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
            border-radius: 20px;
            border: 2px solid var(--gold);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
        }

        .app-header {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #1e3d3d 100%);
            color: var(--gold);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--gold);
        }

        .header-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-icon {
            background: var(--gold);
            color: var(--dark-blue);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .header-btn {
            padding: 6px 14px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            border: 2px solid var(--gold);
            background: transparent;
            color: var(--gold);
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: var(--gold);
            color: var(--dark-blue);
            transform: translateY(-2px);
        }

        .header-btn.reset {
            background: var(--reset-red);
            color: white;
            border-color: transparent;
        }

        .header-btn.reset:hover {
            background: var(--reset-red-dark);
        }

        .header-btn.pdf {
            background: var(--pdf-green);
            color: white;
            border-color: transparent;
        }

        .header-btn.pdf:hover {
            background: var(--pdf-green-dark);
        }

        /* Password Screen */
        .password-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .password-container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            border: 3px solid var(--gold);
            max-width: 380px;
            width: 90%;
            text-align: center;
        }

        .password-container h1 {
            font-family: 'Playfair Display', serif;
            color: var(--dark-blue);
            font-size: 24px;
            margin-bottom: 8px;
        }

        .password-wrapper {
            position: relative;
            margin: 20px 0;
        }

        .password-wrapper input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gold);
            border-radius: 50px;
            font-size: 15px;
            outline: none;
        }

        .toggle-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--maroon);
            font-weight: bold;
            font-size: 13px;
        }

        .unlock-btn {
            background: var(--maroon);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            font-size: 15px;
        }

        .error-msg {
            color: var(--maroon);
            margin-top: 12px;
            display: none;
            font-size: 13px;
        }

        .footer-note {
            margin-top: 25px;
            font-size: 11px;
            color: #666;
        }

        .blinking-text {
            color: var(--maroon);
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #fffcf8;
        }

        /* DASHBOARD SECTION */
        #dashboardSection {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dashboard-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 900px;
            width: 100%;
            padding: 20px;
        }

        .top-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .bottom-row {
            display: flex;
            justify-content: center;
        }

        .dashboard-card {
            background: white;
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 10px rgba(0,0,0,0.03);
            height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .dashboard-card:hover {
            transform: translateY(-3px);
            border-color: var(--bronze);
            box-shadow: 0 8px 15px rgba(188, 140, 79, 0.1);
        }

        .bottom-card {
            width: 70%;
            height: 60px;
            background: #991b1b;
            color: white;
            border: 2px solid #991b1b;
            padding: 10px;
        }

        .bottom-card:hover {
            background: #b91c1c;
        }

        .bottom-card .card-icon {
            font-size: 20px;
        }

        .bottom-card .card-title {
            font-size: 14px;
            color: white;
        }

        .bottom-card .card-desc {
            font-size: 10px;
            color: #fecaca;
        }

        .card-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 5px;
        }

        .card-desc {
            color: #666;
            font-size: 11px;
        }

        .data-status {
            margin-top: 8px;
            color: var(--maroon);
            font-size: 10px;
            font-weight: 600;
        }

        /* INDIVIDUAL SECTION */
        #individualSection, #rootSection {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            flex: 1;
        }

        .fixed-header-section {
            padding: 15px 15px 0 15px;
            background: #fffcf8;
            flex-shrink: 0;
        }

        .border-line {
            border-top: 3px solid var(--gold);
            margin: 20px 0 0 0;
        }

        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            padding: 0 15px 15px 15px;
        }

        .search-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-label {
            font-weight: 700;
            color: var(--maroon);
            font-size: 13px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .search-wrapper {
            position: relative;
            flex: 2;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 8px 15px;
            border: 2px solid #cbd5e1;
            border-radius: 50px;
            font-size: 13px;
            outline: none;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }

        .filter-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 14px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            border: 2px solid var(--gold);
            background: white;
            color: var(--dark-blue);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .filter-btn.active {
            background: #d4edda;
            border-color: var(--dark-green);
        }

        .root-search-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .root-search-input {
            width: 650px;
            padding: 8px 15px;
            border: 2px solid #cbd5e1;
            border-radius: 50px;
            font-size: 13px;
            outline: none;
        }

        .root-search-input:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }

        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--gold);
            border-radius: 0 0 15px 15px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .result-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 13px;
        }

        .result-item:hover {
            background: #faebcd;
        }

        .result-item .main-name {
            font-weight: 700;
            color: var(--dark-blue);
        }

        .result-item .gen {
            color: var(--maroon);
            font-size: 11px;
            margin-left: 6px;
        }

        /* TREE VIEW */
        .tree-root-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: fit-content;
            margin: 0 auto;
            padding: 15px;
        }

        .family-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .children-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 5px;
        }

        .relation-label {
            font-size: 11px;
            color: var(--gold);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--dark-blue);
            padding: 4px 12px;
            border-radius: 20px;
            color: white;
            margin: 5px 0;
        }

        /* BLINKING BOX for selected member - LIGHT GREEN FOR MALE */
        .box {
            border: 2px solid var(--gold);
            border-radius: 12px;
            background: white;
            min-width: 240px;
            max-width: 280px;
            text-align: center;
            cursor: pointer;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .box:hover {
            transform: translateY(-3px);
        }

        .box.blinking-box {
            animation: blinkBoxLightGreen 1.5s infinite;
            border-width: 4px;
            z-index: 10;
            transform: scale(1.02);
        }

        @keyframes blinkBoxLightGreen {
            0%, 100% { 
                border-color: #2e7d32;
                background: #e8f5e9;
                box-shadow: 0 0 15px rgba(46, 125, 50, 0.4);
            }
            50% { 
                border-color: #4caf50;
                background: #c8e6c9;
                box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
                transform: scale(1.05);
            }
        }

        .box-header {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            background: #f8fafc;
            font-size: 10px;
            font-weight: 800;
            border-bottom: 1px solid #ddd;
        }

        .lineage-header {
            background: linear-gradient(135deg, var(--gold) 0%, var(--light-gold) 100%);
        }

        .box-body {
            padding: 12px;
        }

        .member-name {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 16px;
            display: block;
        }

        .father-name {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .female-box {
            background-color: var(--pink-bg) !important;
            border-color: #fb7185 !important;
        }

        .v-line {
            width: 3px;
            height: 25px;
            background: var(--gold);
        }

        .h-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* GOLDEN HEART ICON */
        .golden-heart {
            position: absolute;
            bottom: 5px;
            right: 8px;
            color: var(--gold);
            font-size: 16px;
        }

        /* TABLE VIEW */
        .table-container {
            overflow-x: auto;
            background: white;
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 15px;
        }

        .lineage-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
            font-size: 13px;
        }

        .lineage-table th {
            background: #fdf6e3;
            padding: 8px;
            border-bottom: 2px solid var(--gold);
        }

        .lineage-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #f0e5ce;
        }

        /* ROOT RELATIVE STYLES */
        .root-announce {
            background: var(--light-sage);
            padding: 20px;
            border-radius: 40px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid var(--border-sage);
        }

        .generation-info {
            background: white;
            border-radius: 20px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border-sage);
        }

        .gap-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .gap-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            background: var(--light-sage);
            border-radius: 40px;
            border: 1px solid var(--border-sage);
            font-size: 12px;
        }

        .gap-value {
            font-weight: 700;
            background: white;
            padding: 3px 8px;
            border-radius: 30px;
        }

        .gap-value.highlight {
            background: var(--bronze);
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .app-footer {
            background: var(--dark-blue);
            color: var(--gold);
            text-align: center;
            padding: 8px;
            font-size: 11px;
            border-top: 2px solid var(--gold);
        }

        @media (max-width: 900px) {
            .top-row {
                grid-template-columns: repeat(2, 1fr);
            }
            .bottom-card {
                width: 66.666%;
            }
            .root-search-input {
                width: 100%;
            }
        }

        @media (max-width: 600px) {
            .top-row {
                grid-template-columns: 1fr;
            }
            .bottom-card {
                width: 100%;
            }
            .search-row {
                flex-direction: column;
                align-items: stretch;
            }
            .root-search-row {
                flex-direction: column;
                align-items: stretch;
            }
            .root-search-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Password Screen -->
    <div id="passwordScreen" class="password-screen">
        <div class="password-container">
            <h1>Rizvi Family Tree</h1>
            <p>Honoring our past, preserving our future.</p>
            
            <div class="password-wrapper">
                <input type="password" id="passwordField" placeholder="Enter Secure Password">
                <span class="toggle-btn" onclick="togglePassword()">Show</span>
            </div>

            <button onclick="checkPassword()" class="unlock-btn">Unlock Dashboard</button>
            <div id="passwordError" class="error-msg">Access Denied. Please verify the password.</div>

            <div class="footer-note">
                <p>Designed and updated by.</p>
                <p><strong>Imran Haider S/o Syed Risalat Hussain Rizvi</strong></p>
                <p class="blinking-text">‚ö†Ô∏è Private family access only ‚ö†Ô∏è</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container" style="display: none;">
        <div class="app-header">
            <div class="header-title">
                <span class="header-icon">üåø</span>
                <span id="mainTitle">Rizvi Family Dashboard</span>
            </div>
            <div class="header-actions" id="headerActions"></div>
        </div>

        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none;">

        <div class="main-content" id="mainContent">
            <!-- DASHBOARD SECTION -->
            <div id="dashboardSection">
                <div class="dashboard-grid">
                    <div class="top-row">
                        <div class="dashboard-card" onclick="loadDataWithPassword()">
                            <div class="card-icon">üìÇ</div>
                            <div class="card-title">Load Data</div>
                            <div class="card-desc">Upload Excel file</div>
                            <div class="data-status" id="dataStatus">No data</div>
                        </div>
                        <div class="dashboard-card" onclick="showIndividualSearch()">
                            <div class="card-icon">üë§</div>
                            <div class="card-title">Individual</div>
                            <div class="card-desc">Single member search</div>
                        </div>
                        <div class="dashboard-card" onclick="showRootSearch()">
                            <div class="card-icon">üë•</div>
                            <div class="card-title">Root Relative</div>
                            <div class="card-desc">Two member search</div>
                        </div>
                    </div>
                    <div class="bottom-row">
                        <div class="dashboard-card bottom-card" onclick="logout()">
                            <div class="card-icon" style="color: white;">üö™</div>
                            <div class="card-title" style="color: white;">Exit</div>
                            <div class="card-desc" style="color: #fecaca;">Back to login</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INDIVIDUAL SECTION -->
            <div id="individualSection" class="hidden">
                <div class="fixed-header-section">
                    <div class="search-row">
                        <span class="search-label">SEARCH MEMBER</span>
                        <div class="search-wrapper">
                            <input type="text" id="individualSearch" class="search-input" placeholder="Type name..." onkeyup="searchIndividual(this.value)">
                            <div id="individualDropdown" class="dropdown"></div>
                        </div>
                        <div class="filter-buttons">
                            <div id="filterSiblings" class="filter-btn active" onclick="toggleFilter('siblings')">üë• Siblings</div>
                            <div id="filterDescendants" class="filter-btn active" onclick="toggleFilter('descendants')">üë∂ Descendants</div>
                            <div id="filterAncestors" class="filter-btn" onclick="toggleFilter('ancestors')">üå≥ Ancestors</div>
                        </div>
                    </div>
                    <div class="border-line"></div>
                </div>
                <div class="scrollable-content">
                    <div id="individualTree" class="tree-root-layout">
                        <div style="text-align:center; color:#999; padding:60px;">Select a member to view</div>
                    </div>
                    <div id="individualTable" class="table-container hidden"></div>
                </div>
            </div>

            <!-- ROOT SECTION - WITH FULL FUNCTIONALITY -->
            <div id="rootSection" class="hidden">
                <div class="fixed-header-section">
                    <div class="root-search-row">
                        <span class="search-label">MEMBER 1</span>
                        <div class="search-wrapper" style="width:650px;">
                            <input type="text" id="rootSearch1" class="root-search-input" placeholder="Type name..." onkeyup="searchRootMember(this.value, 1)" autocomplete="off">
                            <div id="rootDropdown1" class="dropdown"></div>
                        </div>
                    </div>
                    <div class="root-search-row">
                        <span class="search-label">MEMBER 2</span>
                        <div class="search-wrapper" style="width:650px;">
                            <input type="text" id="rootSearch2" class="root-search-input" placeholder="Type name..." onkeyup="searchRootMember(this.value, 2)" autocomplete="off">
                            <div id="rootDropdown2" class="dropdown"></div>
                        </div>
                    </div>
                    <div class="border-line"></div>
                </div>
                <div class="scrollable-content">
                    <div id="rootContent" class="tree-viewport">
                        <div style="text-align:center; color:#999; padding:60px;">Select two members to view relationship</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="app-footer">
            Imran Haider S/o Syed Risalat Hussain Rizvi | 0332-787-6010
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            password: 'sihr110',
            dataPassword: '6010'
        };

        // Global variables
        let db = [];
        let currentIndividual = null;
        let rootMember1 = null;
        let rootMember2 = null;
        let individualView = 'tree';
        let rootView = 'tree';
        let showSiblings = true;
        let showDescendants = true;
        let showAncestors = false;

        // Password functions
        function togglePassword() {
            const pwd = document.getElementById('passwordField');
            const toggle = document.querySelector('.toggle-btn');
            pwd.type = pwd.type === 'password' ? 'text' : 'password';
            toggle.textContent = pwd.type === 'password' ? 'Show' : 'Hide';
        }

        function checkPassword() {
            const pwd = document.getElementById('passwordField').value;
            if (pwd === CONFIG.password) {
                document.getElementById('passwordScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                document.getElementById('mainApp').style.flexDirection = 'column';
                showDashboard();
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordField').value = '';
            }
        }

        document.getElementById('passwordField')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkPassword();
        });

        function logout() {
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('passwordScreen').style.display = 'flex';
            document.getElementById('passwordField').value = '';
            document.getElementById('passwordError').style.display = 'none';
        }

        // Load data from file
        function loadDataWithPassword() {
            const pwd = prompt('Enter data loading password:');
            if (pwd === CONFIG.dataPassword) {
                document.getElementById('fileInput').click();
            } else if (pwd !== null) {
                alert('‚ùå Invalid password');
            }
        }

        document.getElementById('fileInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    
                    db = rows.map(r => ({
                        name: String(r.Name || r.name || '').trim(),
                        father: String(r.Father || r.father || '').trim(),
                        gen: String(r.Gen || r.gen || '').trim(),
                        gender: String(r.Gender || r.gender || 'M').trim().toUpperCase()
                    })).filter(p => p.name);

                    // Set first member as current if available
                    currentIndividual = db.length > 0 ? db[0] : null;
                    
                    document.getElementById('dataStatus').innerHTML = `‚úÖ ${db.length}`;
                    alert(`‚úÖ Loaded ${db.length} members`);
                } catch (err) {
                    alert('‚ùå Error: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // Navigation
        function showDashboard() {
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('individualSection').classList.add('hidden');
            document.getElementById('rootSection').classList.add('hidden');
            document.getElementById('mainTitle').innerText = 'Rizvi Family Dashboard';
            updateHeaderButtons('dashboard');
        }

        function showIndividualSearch() {
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('individualSection').classList.remove('hidden');
            document.getElementById('rootSection').classList.add('hidden');
            document.getElementById('mainTitle').innerText = 'Rizvi Family - Individual Search';
            updateHeaderButtons('individual');
            
            // Start with blank search
            document.getElementById('individualSearch').value = '';
            currentIndividual = null;
            
            // Show blank tree
            document.getElementById('individualTree').innerHTML = '<div style="text-align:center; color:#999; padding:60px;">Select a member to view</div>';
            document.getElementById('individualTable').classList.add('hidden');
            document.getElementById('individualTree').classList.remove('hidden');
            individualView = 'tree';
        }

        function showRootSearch() {
            if (!db.length) return alert('Load data first');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('individualSection').classList.add('hidden');
            document.getElementById('rootSection').classList.remove('hidden');
            document.getElementById('mainTitle').innerText = 'Rizvi Family - Search Root Relative';
            updateHeaderButtons('root');
            
            // Clear previous selections
            rootMember1 = null;
            rootMember2 = null;
            document.getElementById('rootSearch1').value = '';
            document.getElementById('rootSearch2').value = '';
            document.getElementById('rootContent').innerHTML = '<div style="text-align:center; color:#999; padding:60px;">Select two members to view relationship</div>';
        }

        function updateHeaderButtons(section) {
            const headerActions = document.getElementById('headerActions');
            headerActions.innerHTML = '';
            
            if (section === 'individual') {
                const viewText = individualView === 'tree' ? 'üìã Switch to Table' : 'üå≤ Switch to Tree';
                headerActions.innerHTML = `
                    <div class="header-btn" onclick="toggleIndividualView()">${viewText}</div>
                    <div class="header-btn reset" onclick="resetIndividual()">üîÑ Reset</div>
                    <div class="header-btn pdf" onclick="exportIndividualPDF()">üìë Save PDF</div>
                    <div class="header-btn" onclick="showDashboard()">üè† Dashboard</div>
                `;
                updateIndividualViewButton();
            } else if (section === 'root') {
                const viewText = rootView === 'tree' ? 'üìã Switch to Table' : 'üå≤ Switch to Tree';
                headerActions.innerHTML = `
                    <div class="header-btn" onclick="toggleRootView()">${viewText}</div>
                    <div class="header-btn reset" onclick="resetRoot()">üîÑ Reset</div>
                    <div class="header-btn pdf" onclick="exportRootPDF()">üìë Save PDF</div>
                    <div class="header-btn" onclick="showDashboard()">üè† Dashboard</div>
                `;
            } else {
                headerActions.innerHTML = '';
            }
        }

        function updateIndividualViewButton() {
            // Kept for compatibility
        }

        // Individual functions
        function resetIndividual() {
            document.getElementById('individualSearch').value = '';
            currentIndividual = null;
            document.getElementById('individualTree').innerHTML = '<div style="text-align:center; color:#999; padding:60px;">Select a member to view</div>';
            document.getElementById('individualTable').innerHTML = '';
            if (individualView === 'table') {
                document.getElementById('individualTree').classList.remove('hidden');
                document.getElementById('individualTable').classList.add('hidden');
                individualView = 'tree';
                updateHeaderButtons('individual');
            }
        }

        function toggleIndividualView() {
            if (!currentIndividual) return;
            individualView = individualView === 'tree' ? 'table' : 'tree';
            updateHeaderButtons('individual');
            renderIndividualView();
        }

        function toggleFilter(filter) {
            if (!currentIndividual) return;
            
            if (filter === 'siblings') {
                showSiblings = !showSiblings;
                document.getElementById('filterSiblings').classList.toggle('active', showSiblings);
            } else if (filter === 'descendants') {
                showDescendants = !showDescendants;
                document.getElementById('filterDescendants').classList.toggle('active', showDescendants);
            } else if (filter === 'ancestors') {
                showAncestors = !showAncestors;
                document.getElementById('filterAncestors').classList.toggle('active', showAncestors);
            }
            renderIndividualView();
        }

        // Root functions - UPDATED WITH FULL LOGIC
        function resetRoot() {
            rootMember1 = null;
            rootMember2 = null;
            document.getElementById('rootSearch1').value = '';
            document.getElementById('rootSearch2').value = '';
            document.getElementById('rootContent').innerHTML = '<div style="text-align:center; color:#999; padding:60px;">Select two members to view relationship</div>';
        }

        function toggleRootView() {
            rootView = rootView === 'tree' ? 'table' : 'tree';
            updateHeaderButtons('root');
            if (rootMember1 && rootMember2) {
                if (rootView === 'tree') renderRootTree();
                else renderRootTable();
            }
        }

        // Find common ancestor between two members
        function findCommonRoot(m1, m2) {
            const chain1 = getAncestryChain(m1);
            const chain2 = getAncestryChain(m2);
            
            for (let p of chain1) {
                if (chain2.some(x => x.name.toLowerCase() === p.name.toLowerCase())) {
                    return p; // Common ancestor found
                }
            }
            return null; // No common ancestor
        }

        // Render Root Tree View (side-by-side columns)
        function renderRootTree() {
            if (!rootMember1 || !rootMember2) return;
            
            const chain1 = getAncestryChain(rootMember1);
            const chain2 = getAncestryChain(rootMember2);
            const commonRoot = findCommonRoot(rootMember1, rootMember2);
            
            if (!commonRoot) {
                document.getElementById('rootContent').innerHTML = 
                    '<div class="root-announce"><h3>No common ancestor found</h3></div>';
                return;
            }
            
            // Calculate generation gaps
            const gen1 = getGenNum(rootMember1.gen);
            const gen2 = getGenNum(rootMember2.gen);
            const genRoot = getGenNum(commonRoot.gen);
            const gap1 = Math.abs(gen1 - genRoot);
            const gap2 = Math.abs(gen2 - genRoot);
            const gap12 = Math.abs(gen1 - gen2);
            
            let html = `
                <div class="root-announce">
                    <h3>Common Root: ${displayName(commonRoot.name)} (${commonRoot.gen})</h3>
                    <div class="generation-info">
                        <div class="gap-row">
                            <div class="gap-item">Member 1 ‚Üí Root <span class="gap-value">${gap1} gen</span></div>
                            <div class="gap-item">Member 2 ‚Üí Root <span class="gap-value">${gap2} gen</span></div>
                            <div class="gap-item">Member 1 ‚Üî Member 2 <span class="gap-value highlight">${gap12} gen</span></div>
                        </div>
                    </div>
                </div>
                <div class="tree-root-layout">
                    <div style="display:flex; gap:30px; flex-wrap:wrap; justify-content:center;">
            `;
            
            // Path for Member 1
            const path1 = chain1.slice(0, chain1.findIndex(p => p.name.toLowerCase() === commonRoot.name.toLowerCase()) + 1);
            html += `<div><h4>${displayName(rootMember1.name)}'s Path</h4>`;
            path1.forEach((p, i) => {
                const label = i === 0 ? 'Member' : (i === path1.length-1 ? 'Root' : 'Ancestor');
                const hasChildren = db.some(x => x.father && x.father.toLowerCase() === p.name.toLowerCase());
                html += renderBox(p, label, p.name === rootMember1.name, hasChildren);
                if (i < path1.length - 1) html += '<div class="v-line"></div>';
            });
            html += '</div>';
            
            // Path for Member 2
            const path2 = chain2.slice(0, chain2.findIndex(p => p.name.toLowerCase() === commonRoot.name.toLowerCase()) + 1);
            html += `<div><h4>${displayName(rootMember2.name)}'s Path</h4>`;
            path2.forEach((p, i) => {
                const label = i === 0 ? 'Member' : (i === path2.length-1 ? 'Root' : 'Ancestor');
                const hasChildren = db.some(x => x.father && x.father.toLowerCase() === p.name.toLowerCase());
                html += renderBox(p, label, p.name === rootMember2.name, hasChildren);
                if (i < path2.length - 1) html += '<div class="v-line"></div>';
            });
            html += '</div></div></div>';
            
            document.getElementById('rootContent').innerHTML = html;
        }

        // Render Root Table View
        function renderRootTable() {
            if (!rootMember1 || !rootMember2) return;
            
            const chain1 = getAncestryChain(rootMember1);
            const chain2 = getAncestryChain(rootMember2);
            const commonRoot = findCommonRoot(rootMember1, rootMember2);
            
            if (!commonRoot) {
                document.getElementById('rootContent').innerHTML = 
                    '<div class="root-announce"><h3>No common ancestor found</h3></div>';
                return;
            }
            
            const gen1 = getGenNum(rootMember1.gen);
            const gen2 = getGenNum(rootMember2.gen);
            const genRoot = getGenNum(commonRoot.gen);
            const gap1 = Math.abs(gen1 - genRoot);
            const gap2 = Math.abs(gen2 - genRoot);
            const gap12 = Math.abs(gen1 - gen2);
            
            let html = `
                <div class="root-announce">
                    <h3>Common Root: ${displayName(commonRoot.name)} (${commonRoot.gen})</h3>
                    <div class="generation-info">
                        <div class="gap-row">
                            <div class="gap-item">Member 1 ‚Üí Root <span class="gap-value">${gap1} gen</span></div>
                            <div class="gap-item">Member 2 ‚Üí Root <span class="gap-value">${gap2} gen</span></div>
                            <div class="gap-item">Member 1 ‚Üî Member 2 <span class="gap-value highlight">${gap12} gen</span></div>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <div style="display:flex; gap:20px; flex-wrap:wrap;">
            `;
            
            // Table for Member 1
            const path1 = chain1.slice(0, chain1.findIndex(p => p.name.toLowerCase() === commonRoot.name.toLowerCase()) + 1);
            html += `<div style="flex:1"><h4>${displayName(rootMember1.name)}'s Path</h4>
                <table class="lineage-table">
                    <tr><th>#</th><th>Name</th><th>Gen</th></tr>`;
            path1.forEach((p, i) => {
                html += `<tr><td>${i+1}</td><td>${displayName(p.name)}</td><td>${p.gen}</td></tr>`;
            });
            html += '</table></div>';
            
            // Table for Member 2
            const path2 = chain2.slice(0, chain2.findIndex(p => p.name.toLowerCase() === commonRoot.name.toLowerCase()) + 1);
            html += `<div style="flex:1"><h4>${displayName(rootMember2.name)}'s Path</h4>
                <table class="lineage-table">
                    <tr><th>#</th><th>Name</th><th>Gen</th></tr>`;
            path2.forEach((p, i) => {
                html += `<tr><td>${i+1}</td><td>${displayName(p.name)}</td><td>${p.gen}</td></tr>`;
            });
            html += '</table></div></div></div>';
            
            document.getElementById('rootContent').innerHTML = html;
        }

        // PDF functions
        async function exportIndividualPDF() {
            if (!currentIndividual) return alert('Select a member first');
            
            const content = individualView === 'tree' ? document.getElementById('individualTree') : document.getElementById('individualTable');
            const originalContent = content.innerHTML;
            
            try {
                content.innerHTML = '<div style="padding:40px; text-align:center; font-size:16px;">üìÑ Generating PDF...</div>';
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const canvas = await html2canvas(content, { 
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: false,
                    useCORS: true
                });
                
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                const pdf = new jsPDF({
                    orientation: imgHeight > pageHeight ? 'p' : 'l',
                    unit: 'mm'
                });
                
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`family-${displayName(currentIndividual.name)}.pdf`);
                
                content.innerHTML = originalContent;
                
            } catch (err) {
                alert('PDF error: ' + err.message);
                content.innerHTML = originalContent;
            }
        }

        async function exportRootPDF() {
            if (!rootMember1 || !rootMember2) return alert('Select both members first');
            
            const content = document.getElementById('rootContent');
            const originalContent = content.innerHTML;
            
            try {
                content.innerHTML = '<div style="padding:40px; text-align:center; font-size:16px;">üìÑ Generating PDF...</div>';
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const canvas = await html2canvas(content, { 
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: false,
                    useCORS: true
                });
                
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                const pdf = new jsPDF({
                    orientation: imgHeight > pageHeight ? 'p' : 'l',
                    unit: 'mm'
                });
                
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`root-${displayName(rootMember1.name)}-${displayName(rootMember2.name)}.pdf`);
                
                content.innerHTML = originalContent;
                
            } catch (err) {
                alert('PDF error: ' + err.message);
                content.innerHTML = originalContent;
            }
        }

        // Search functions
        function searchIndividual(query) {
            if (!db.length) return;
            
            const drop = document.getElementById('individualDropdown');
            performSearch(query, drop, (member) => {
                document.getElementById('individualSearch').value = displayName(member.name) + ' (' + member.gen + ')';
                currentIndividual = member;
                renderIndividualView();
            });
        }

        function searchRootMember(query, num) {
            if (!db.length) return;
            
            const drop = document.getElementById(`rootDropdown${num}`);
            performSearch(query, drop, (member) => {
                document.getElementById(`rootSearch${num}`).value = displayName(member.name) + ' (' + member.gen + ')';
                if (num === 1) rootMember1 = member;
                else rootMember2 = member;
                
                // Auto-render when both members selected
                if (rootMember1 && rootMember2) {
                    if (rootView === 'tree') renderRootTree();
                    else renderRootTable();
                }
            });
        }

        function performSearch(query, drop, callback) {
            if (!drop) return;
            
            drop.innerHTML = '';
            if (!query || query.length < 1) {
                drop.style.display = 'none';
                return;
            }
            
            const found = db.filter(p => p.name.toLowerCase().includes(query.toLowerCase())).slice(0, 8);
            if (found.length === 0) {
                drop.style.display = 'none';
                return;
            }
            
            found.forEach(p => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `<div><span class="main-name">${displayName(p.name)}</span> <span class="gen">(${p.gen})</span></div>
                    <div style="font-size:11px;">${p.gender?.startsWith('F') ? 'D/o' : 'S/o'} ${displayName(p.father)}</div>`;
                div.onclick = () => {
                    callback(p);
                    drop.style.display = 'none';
                };
                drop.appendChild(div);
            });
            
            drop.style.display = 'block';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-wrapper')) {
                document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
            }
        });

        // Utilities
        function displayName(str) {
            return str ? str.replace(/\s*-\s*\d+$/, '').trim() : '';
        }

        function properCase(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        }

        function findParent(p) {
            if (!p || !p.father) return null;
            return db.find(x => x.name.toLowerCase() === p.father.toLowerCase());
        }

        function getGenNum(gen) {
            const match = String(gen).match(/\d+/);
            return match ? parseInt(match[0]) : 0;
        }

        function getAncestryChain(p) {
            let chain = [], cur = p, visited = new Set();
            while (cur && !visited.has(cur.name.toLowerCase())) {
                chain.push(cur);
                visited.add(cur.name.toLowerCase());
                cur = findParent(cur);
            }
            return chain;
        }

        // Handle box click
        function handleBoxClick(member) {
            if (!document.getElementById('individualSection').classList.contains('hidden')) {
                currentIndividual = member;
                document.getElementById('individualSearch').value = displayName(member.name) + ' (' + member.gen + ')';
                renderIndividualView();
            } else if (!document.getElementById('rootSection').classList.contains('hidden')) {
                // For root section, we need to decide which member to set
                // For now, just show alert
                alert(`Clicked on ${member.name} in root section`);
            }
        }

        // Render functions
        function renderIndividualView() {
            if (!currentIndividual) return;
            
            if (individualView === 'tree') {
                document.getElementById('individualTree').classList.remove('hidden');
                document.getElementById('individualTable').classList.add('hidden');
                renderIndividualTree();
            } else {
                document.getElementById('individualTree').classList.add('hidden');
                document.getElementById('individualTable').classList.remove('hidden');
                renderIndividualTable();
            }
        }

        function renderIndividualTree() {
            let html = '<div class="tree-root-layout">';
            
            // Get ancestors chain (excluding current)
            const ancestors = getAncestryChain(currentIndividual).slice(1);
            
            // Show ancestors if enabled
            if (showAncestors && ancestors.length > 0) {
                html += '<div class="family-group">';
                html += '<div class="relation-label">ANCESTORS</div>';
                [...ancestors].reverse().forEach((a, idx) => {
                    const hasChildren = db.some(x => x.father && x.father.toLowerCase() === a.name.toLowerCase());
                    html += renderBox(a, idx === 0 ? 'Earliest' : 'Ancestor', false, hasChildren);
                    if (idx < ancestors.length - 1) html += '<div class="v-line"></div>';
                });
                html += '<div class="v-line"></div>';
                html += '</div>';
            }
            
            // Father - only show if NOT already in ancestors
            const father = findParent(currentIndividual);
            const fatherInAncestors = showAncestors && ancestors.some(a => a.name === father?.name);
            
            if (father && !fatherInAncestors) {
                const fatherHasChildren = db.some(x => x.father && x.father.toLowerCase() === father.name.toLowerCase());
                html += '<div class="family-group">';
                html += renderBox(father, 'Father', false, fatherHasChildren);
                html += '<div class="v-line"></div>';
                
                const currentHasChildren = db.some(x => x.father && x.father.toLowerCase() === currentIndividual.name.toLowerCase());
                html += renderBox(currentIndividual, 'Selected', true, currentHasChildren);
                html += '</div>';
            } else if (father && fatherInAncestors) {
                const currentHasChildren = db.some(x => x.father && x.father.toLowerCase() === currentIndividual.name.toLowerCase());
                html += '<div class="family-group">';
                html += renderBox(currentIndividual, 'Selected', true, currentHasChildren);
                html += '</div>';
            } else {
                const currentHasChildren = db.some(x => x.father && x.father.toLowerCase() === currentIndividual.name.toLowerCase());
                html += '<div class="family-group">';
                html += renderBox(currentIndividual, 'Selected', true, currentHasChildren);
                html += '</div>';
            }
            
            // Siblings
            if (showSiblings && father) {
                const siblings = db.filter(s => s.father && s.father.toLowerCase() === currentIndividual.father.toLowerCase() && s.name !== currentIndividual.name);
                if (siblings.length > 0) {
                    html += '<div class="family-group">';
                    html += '<div class="relation-label">SIBLINGS</div>';
                    html += '<div class="children-row">';
                    siblings.forEach(s => {
                        const hasChildren = db.some(x => x.father && x.father.toLowerCase() === s.name.toLowerCase());
                        html += renderBox(s, s.gender?.startsWith('F') ? 'Sister' : 'Brother', false, hasChildren);
                    });
                    html += '</div>';
                    html += '</div>';
                }
            }
            
            // Descendants
            if (showDescendants) {
                const children = db.filter(c => c.father && c.father.toLowerCase() === currentIndividual.name.toLowerCase());
                if (children.length > 0) {
                    html += '<div class="family-group">';
                    html += '<div class="v-line"></div>';
                    html += '<div class="relation-label">CHILDREN</div>';
                    html += '<div class="children-row">';
                    children.forEach(c => {
                        const hasChildren = db.some(x => x.father && x.father.toLowerCase() === c.name.toLowerCase());
                        html += renderBox(c, c.gender?.startsWith('F') ? 'Daughter' : 'Son', false, hasChildren);
                    });
                    html += '</div>';
                    html += '</div>';
                }
            }
            
            html += '</div>';
            document.getElementById('individualTree').innerHTML = html;
        }

        function renderIndividualTable() {
            let html = '<div class="table-container"><table class="lineage-table">';
            html += '<tr><th>Name</th><th>Gen</th><th>Father</th></tr>';
            html += `<tr><td>${displayName(currentIndividual.name)}</td><td>${currentIndividual.gen}</td><td>${displayName(currentIndividual.father)}</td></tr>`;
            
            if (showAncestors) {
                const ancestors = getAncestryChain(currentIndividual).slice(1);
                if (ancestors.length > 0) {
                    html += '<tr><th colspan="3">Ancestors</th></tr>';
                    ancestors.forEach(a => {
                        html += `<tr><td>${displayName(a.name)}</td><td>${a.gen}</td><td>${displayName(a.father)}</td></tr>`;
                    });
                }
            }
            
            if (showSiblings && currentIndividual.father) {
                const siblings = db.filter(s => s.father && s.father.toLowerCase() === currentIndividual.father.toLowerCase() && s.name !== currentIndividual.name);
                if (siblings.length > 0) {
                    html += '<tr><th colspan="3">Siblings</th></tr>';
                    siblings.forEach(s => {
                        html += `<tr><td>${displayName(s.name)}</td><td>${s.gen}</td><td>${displayName(s.father)}</td></tr>`;
                    });
                }
            }
            
            if (showDescendants) {
                const kids = db.filter(c => c.father && c.father.toLowerCase() === currentIndividual.name.toLowerCase());
                if (kids.length > 0) {
                    html += '<tr><th colspan="3">Children</th></tr>';
                    kids.forEach(k => {
                        html += `<tr><td>${displayName(k.name)}</td><td>${k.gen}</td><td>${displayName(k.father)}</td></tr>`;
                    });
                }
            }
            
            html += '</table></div>';
            document.getElementById('individualTable').innerHTML = html;
        }

        function renderBox(p, label, isSelected, hasChildren) {
            const isFemale = p.gender?.startsWith('F');
            const blinkClass = isSelected ? 'blinking-box' : '';
            const safeName = JSON.stringify(p.name).replace(/'/g, "\\'");
            
            return `<div class="box ${isFemale ? 'female-box' : ''} ${blinkClass}" onclick='handleBoxClick(${JSON.stringify(p).replace(/'/g, "\\'")})'>
                <div class="box-header"><span>${label}</span><span>${p.gen}</span></div>
                <div class="box-body">
                    <span class="member-name">${displayName(p.name)}</span>
                    <span class="father-name">${isFemale ? 'D/o' : 'S/o'}: ${displayName(p.father)}</span>
                    ${hasChildren ? '<div class="golden-heart">‚ù§Ô∏è</div>' : ''}
                </div>
            </div>`;
        }
    </script>
</body>
</html>